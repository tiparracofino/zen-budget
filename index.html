<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Èñì ‚Äî Ma Budget</title>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,500;1,300;1,400&family=Zen+Kaku+Gothic+New:wght@300;400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --bg-dark: #181715;
    --bg-pill: #2C2B28;
    --text-gold: #C2A878;
    --text-green: #8DA980;
    --bg-banner: #4B6342;
    --text-banner-light: #C8D8BF;
    --bg-list-header: #EBE6DA;
    --bg-card: #FDFBF7;
    --text-main: #1C1C1A;
    --text-muted: #6B6B65;
    --border: rgba(28,28,26,0.06);
    --aka: #B04A4A;
  }

  * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color: transparent; }
  html, body { height: 100%; overflow: hidden; background: var(--bg-list-header); }

  body { font-family: 'Zen Kaku Gothic New', sans-serif; color: var(--text-main); font-size: 15px; }

  .app { display: flex; flex-direction: column; height: 100%; max-width: 480px; margin: 0 auto; background: var(--bg-list-header); position: relative; }

  /* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
  .top-header { background: var(--bg-dark); padding: 48px 20px 16px; flex-shrink: 0; }
  .top-bar { display: flex; align-items: center; justify-content: space-between; margin-bottom: 24px; }
  .logo { font-family: 'Cormorant Garamond', serif; font-size: 24px; color: var(--text-gold); letter-spacing: 0.12em; }
  .month-nav { display: flex; align-items: center; background: var(--bg-pill); border-radius: 20px; padding: 2px 4px; }
  .month-btn { background: none; border: none; color: rgba(255,255,255,0.5); width: 30px; height: 30px; font-size: 16px; cursor: pointer; }
  .month-label { font-size: 13px; color: rgba(255,255,255,0.85); padding: 0 8px; min-width: 100px; text-align: center; }
  
  .summary-pills { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; }
  .pill { background: var(--bg-pill); border-radius: 12px; padding: 12px 8px; text-align: center; }
  .pill-label { font-size: 9px; letter-spacing: 0.1em; text-transform: uppercase; color: rgba(255,255,255,0.4); margin-bottom: 4px; display: block; }
  .pill-value { font-family: 'Cormorant Garamond', serif; font-size: 17px; color: rgba(255,255,255,0.85); }
  .pill-value.green { color: var(--text-green); }
  .pill-value.neg-red { color: var(--aka) !important; font-weight: 600; }

  /* ‚îÄ‚îÄ BANNER ‚îÄ‚îÄ */
  .assign-banner { background: var(--bg-banner); padding: 16px 20px; display: flex; align-items: center; justify-content: space-between; flex-shrink: 0; }
  .assign-value { font-family: 'Cormorant Garamond', serif; font-size: 26px; color: var(--text-banner-light); }

  /* ‚îÄ‚îÄ CONTENT ‚îÄ‚îÄ */
  .content { flex: 1; overflow-y: auto; padding-bottom: 100px; }
  .panel { display: none; }
  .panel.active { display: block; }

  /* ‚îÄ‚îÄ SECCIONES DE GESTI√ìN (Pesta√±a Cuentas) ‚îÄ‚îÄ */
  .manage-section { margin-bottom: 32px; }
  .section-header { display: flex; align-items: center; justify-content: space-between; padding: 20px 20px 10px; border-bottom: 1px solid var(--border); }
  .section-title { font-size: 11px; text-transform: uppercase; letter-spacing: 0.15em; color: var(--text-muted); font-weight: 700; }
  
  /* ‚îÄ‚îÄ FILAS ‚îÄ‚îÄ */
  .row { display: grid; grid-template-columns: 1fr auto auto; padding: 16px 20px; background: var(--bg-card); border-bottom: 1px solid var(--border); align-items: center; }
  .row-info { display: flex; align-items: center; gap: 12px; }
  .row-main { font-size: 15px; color: var(--text-main); }
  .row-sub { font-size: 12px; color: var(--text-muted); }
  .val-assigned { font-size: 14px; text-align: right; padding: 4px 8px; border-radius: 6px; color: var(--text-muted); }
  .val-avail { font-size: 14px; text-align: right; min-width: 80px; }
  .pos { color: var(--bg-banner); }
  .neg { color: var(--aka); }

  .group-header { background: var(--bg-list-header); padding: 10px 20px; font-size: 10px; text-transform: uppercase; letter-spacing: 0.1em; color: var(--text-muted); display: flex; justify-content: space-between; align-items: center; }

  /* ‚îÄ‚îÄ NAV ‚îÄ‚îÄ */
  .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: var(--bg-dark); display: flex; padding-bottom: env(safe-area-inset-bottom); border-top: 1px solid var(--border-dark); }
  .nav-tab { flex: 1; display: flex; flex-direction: column; align-items: center; padding: 12px 0; color: rgba(255,255,255,0.4); background: none; border: none; font-size: 18px; }
  .nav-tab.active { color: var(--text-gold); }
  .nav-label { font-size: 8px; text-transform: uppercase; margin-top: 4px; }

  .fab { position: fixed; bottom: 85px; right: 20px; width: 56px; height: 56px; background: var(--bg-banner); border-radius: 50%; color: white; font-size: 24px; border: none; box-shadow: 0 4px 12px rgba(0,0,0,0.3); }

  /* ‚îÄ‚îÄ MODALS ‚îÄ‚îÄ */
  .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); display: none; align-items: flex-end; z-index: 100; }
  .overlay.open { display: flex; }
  .sheet { background: var(--bg-card); width: 100%; padding: 24px; border-radius: 20px 20px 0 0; }
  .form-input { width: 100%; padding: 14px; margin-bottom: 12px; border: 1px solid var(--border); border-radius: 10px; font-size: 15px; }
  .btn-save { width: 100%; padding: 16px; background: var(--bg-banner); color: white; border: none; border-radius: 12px; font-size: 16px; }

  .toast { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%); background: var(--bg-dark); color: white; padding: 12px 24px; border-radius: 8px; opacity: 0; transition: 0.3s; z-index: 200; }
  .toast.show { opacity: 1; }
</style>
</head>
<body>

<div class="app">
  <div class="top-header">
    <div class="top-bar">
      <div class="logo">Èñì Ma</div>
      <div class="month-nav">
        <button class="month-btn" onclick="changeMonth(-1)">‚Äπ</button>
        <span class="month-label" id="monthLabel"></span>
        <button class="month-btn" onclick="changeMonth(1)">‚Ä∫</button>
      </div>
      <div style="width:24px"></div>
    </div>
    <div class="summary-pills">
      <div class="pill"><span class="pill-label">Asignado</span><span class="pill-value" id="s-assigned"></span></div>
      <div class="pill"><span class="pill-label">Gastado</span><span class="pill-value" id="s-spent"></span></div>
      <div class="pill"><span class="pill-label">Disponible</span><span class="pill-value" id="s-avail"></span></div>
    </div>
  </div>

  <div class="assign-banner">
    <div style="font-size: 9px; text-transform: uppercase; color: var(--text-banner-light); opacity: 0.7">Para asignar</div>
    <div class="assign-value" id="toAssignVal"></div>
  </div>

  <div class="content">
    
    <div class="panel active" id="panel-budget">
      <div id="budgetBody"></div>
    </div>

    <div class="panel" id="panel-mov">
      <div id="txBody"></div>
    </div>

    <div class="panel" id="panel-manage">
      
      <div class="manage-section">
        <div class="section-header">
          <span class="section-title">Cuentas y Saldo</span>
          <button class="btn-tiny-add" onclick="openAccountSheet()">+</button>
        </div>
        <div id="manage-accounts-list"></div>
        <div style="padding: 15px 20px; text-align: right">
            <span style="font-size: 11px; color: var(--text-muted)">PATRIMONIO: </span>
            <span id="total-net-worth" style="font-weight: 500"></span>
        </div>
      </div>

      <div class="manage-section">
        <div class="section-header">
          <span class="section-title">Grupos y Categor√≠as</span>
          <button class="btn-tiny-add" onclick="openGroupSheet()">+ Grupo</button>
        </div>
        <div id="manage-structure-list"></div>
      </div>
    </div>

  </div>

  <button class="fab" onclick="openTxSheet()">+</button>
  <nav class="bottom-nav">
    <button class="nav-tab active" onclick="showPanel('budget', this)">‚äû<span class="nav-label">Plan</span></button>
    <button class="nav-tab" onclick="showPanel('mov', this)">‚â°<span class="nav-label">Mov</span></button>
    <button class="nav-tab" onclick="showPanel('manage', this)">üè¶<span class="nav-label">Gestionar</span></button>
  </nav>
</div>

<div id="toast" class="toast"></div>

<div class="overlay" id="overlay-assign" onclick="this.classList.remove('open')">
    <div class="sheet" onclick="event.stopPropagation()">
        <h3 id="assign-title" style="margin-bottom:15px">Asignar</h3>
        <input type="number" id="inp-amount" class="form-input" placeholder="0.00">
        <button class="btn-save" onclick="saveAssign()">Guardar</button>
    </div>
</div>

<div class="overlay" id="overlay-tx" onclick="this.classList.remove('open')">
    <div class="sheet" onclick="event.stopPropagation()">
        <div style="display:flex; gap:10px; margin-bottom:15px">
            <button id="btn-t-exp" onclick="setTxType('expense')" style="flex:1; padding:10px; border-radius:8px; border:1px solid #ddd; background:#181715; color:white">Gasto</button>
            <button id="btn-t-inc" onclick="setTxType('income')" style="flex:1; padding:10px; border-radius:8px; border:1px solid #ddd; background:white">Ingreso</button>
        </div>
        <input type="date" id="tx-date" class="form-input">
        <input type="text" id="tx-concept" class="form-input" placeholder="Concepto">
        <input type="number" id="tx-amount" class="form-input" placeholder="0.00">
        <select id="tx-account" class="form-input"></select>
        <select id="tx-category" class="form-input"></select>
        <button class="btn-save" onclick="saveTx()">Registrar</button>
    </div>
</div>

<div class="overlay" id="overlay-account" onclick="this.classList.remove('open')">
    <div class="sheet" onclick="event.stopPropagation()">
        <h3>Nueva Cuenta</h3>
        <input type="text" id="acc-emoji" class="form-input" placeholder="Emoji (üè¶)">
        <input type="text" id="acc-name" class="form-input" placeholder="Nombre (Ej: BBVA)">
        <input type="number" id="acc-balance" class="form-input" placeholder="Saldo inicial">
        <button class="btn-save" onclick="saveNewAccount()">Crear Cuenta</button>
    </div>
</div>

<div class="overlay" id="overlay-group" onclick="this.classList.remove('open')">
    <div class="sheet" onclick="event.stopPropagation()">
        <h3>Nuevo Grupo</h3>
        <input type="text" id="group-name" class="form-input" placeholder="Nombre del grupo">
        <button class="btn-save" onclick="saveNewGroup()">Crear Grupo</button>
    </div>
</div>

<div class="overlay" id="overlay-cat" onclick="this.classList.remove('open')">
    <div class="sheet" onclick="event.stopPropagation()">
        <h3>Nueva Categor√≠a</h3>
        <input type="text" id="cat-emoji" class="form-input" placeholder="Emoji">
        <input type="text" id="cat-name" class="form-input" placeholder="Nombre">
        <button class="btn-save" onclick="saveNewCat()">A√±adir</button>
    </div>
</div>

<script>
// --- MOTOR DE DATOS ---
const STORAGE_KEY = 'MA_DATA_V2';
const defaultState = {
    month: new Date().toISOString(),
    transactions: [],
    assignments: {},
    accounts: [{ id: 'a1', name: 'Efectivo', emoji: 'üíµ' }],
    groups: [{ id: 'g1', name: 'Gastos Fijos', cats: [{ id: 'c1', name: 'Alquiler', emoji: 'üè†' }] }]
};

let state = JSON.parse(localStorage.getItem(STORAGE_KEY)) || defaultState;
state.currentMonthDate = new Date(state.month);

function save() {
    state.month = state.currentMonthDate.toISOString();
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    render();
}

// --- UTILIDADES ---
const fmt = (n) => (n < 0 ? '-' : '') + '‚Ç¨' + Math.abs(n).toFixed(2).replace('.', ',');
const getMStr = (d) => `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
const MONTHS = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];

function render() {
    const mStr = getMStr(state.currentMonthDate);
    document.getElementById('monthLabel').textContent = MONTHS[state.currentMonthDate.getMonth()] + ' ' + state.currentMonthDate.getFullYear();

    // 1. C√°lculos de Barra Superior
    let totalIn = 0, totalAssignedMonth = 0, totalSpentMonth = 0, totalAssignedAll = 0;
    state.transactions.forEach(t => { if(t.type==='income' && t.date <= mStr + '-31') totalIn += t.amount; });
    Object.keys(state.assignments).forEach(m => {
        let monthTotal = Object.values(state.assignments[m]).reduce((a,b)=>a+b,0);
        if(m <= mStr) totalAssignedAll += monthTotal;
        if(m === mStr) totalAssignedMonth = monthTotal;
    });
    
    // 2. Render Plan (Presupuesto)
    const budgetBody = document.getElementById('budgetBody');
    budgetBody.innerHTML = '';
    state.groups.forEach(g => {
        let gHTML = `<div class="group-header"><span>${g.name}</span></div>`;
        g.cats.forEach(c => {
            let assigned = (state.assignments[mStr] && state.assignments[mStr][c.id]) || 0;
            let spent = state.transactions.filter(t => t.type==='expense' && t.categoryId===c.id && getMStr(new Date(t.date))===mStr).reduce((a,b)=>a+b.amount,0);
            if(getMStr(new Date()) === mStr) totalSpentMonth += spent;
            let avail = assigned - spent;
            gHTML += `
                <div class="row" onclick="openAssignSheet('${c.id}', '${c.name}', ${assigned})">
                    <div class="row-info"><span>${c.emoji}</span><span>${c.name}</span></div>
                    <div class="val-assigned">${fmt(assigned)}</div>
                    <div class="val-avail ${avail < 0 ? 'neg' : 'pos'}">${fmt(avail)}</div>
                </div>`;
        });
        budgetBody.innerHTML += gHTML;
    });

    // 3. Render Gestionar (Cuentas + Estructura)
    const accList = document.getElementById('manage-accounts-list');
    accList.innerHTML = '';
    let netWorth = 0;
    state.accounts.forEach(acc => {
        let bal = 0;
        state.transactions.forEach(t => { if(t.accountId === acc.id) bal += (t.type==='income'?t.amount:-t.amount); });
        netWorth += bal;
        accList.innerHTML += `<div class="row"><div>${acc.emoji} ${acc.name}</div><div></div><div class="val-avail">${fmt(bal)}</div></div>`;
    });
    document.getElementById('total-net-worth').textContent = fmt(netWorth);

    const structList = document.getElementById('manage-structure-list');
    structList.innerHTML = '';
    state.groups.forEach(g => {
        structList.innerHTML += `<div class="group-header"><span>${g.name}</span><button onclick="openCatSheet('${g.id}')" style="background:none; border:none; color:var(--text-gold)">+ Categor√≠a</button></div>`;
        g.cats.forEach(c => {
            structList.innerHTML += `<div class="row"><div>${c.emoji} ${c.name}</div></div>`;
        });
    });

    // 4. Barra Superior
    document.getElementById('s-assigned').textContent = fmt(totalAssignedMonth);
    document.getElementById('s-spent').textContent = fmt(totalSpentMonth);
    const availFinal = totalAssignedMonth - totalSpentMonth;
    const availEl = document.getElementById('s-avail');
    availEl.textContent = fmt(availFinal);
    availEl.className = 'pill-value ' + (availFinal < 0 ? 'neg-red' : 'green');
    document.getElementById('toAssignVal').textContent = fmt(totalIn - totalAssignedAll);
}

// --- ACCIONES ---
let activeCatId, activeGroupId;
function openAssignSheet(id, name, val) { 
    activeCatId = id; 
    document.getElementById('assign-title').textContent = name;
    document.getElementById('inp-amount').value = val;
    document.getElementById('overlay-assign').classList.add('open');
}
function saveAssign() {
    const mStr = getMStr(state.currentMonthDate);
    if(!state.assignments[mStr]) state.assignments[mStr] = {};
    state.assignments[mStr][activeCatId] = parseFloat(document.getElementById('inp-amount').value) || 0;
    document.getElementById('overlay-assign').classList.remove('open');
    save();
}

function openTxSheet() {
    const accS = document.getElementById('tx-account'); accS.innerHTML = '';
    state.accounts.forEach(a => accS.innerHTML += `<option value="${a.id}">${a.name}</option>`);
    const catS = document.getElementById('tx-category'); catS.innerHTML = '';
    state.groups.forEach(g => g.cats.forEach(c => catS.innerHTML += `<option value="${c.id}">${g.name} > ${c.name}</option>`));
    document.getElementById('tx-date').valueAsDate = new Date();
    document.getElementById('overlay-tx').classList.add('open');
}

function saveTx() {
    state.transactions.push({
        type: currentTxType,
        concept: document.getElementById('tx-concept').value,
        amount: parseFloat(document.getElementById('tx-amount').value),
        date: document.getElementById('tx-date').value,
        accountId: document.getElementById('tx-account').value,
        categoryId: document.getElementById('tx-category').value
    });
    document.getElementById('overlay-tx').classList.remove('open');
    save();
}

let currentTxType = 'expense';
function setTxType(t) {
    currentTxType = t;
    document.getElementById('btn-t-exp').style.background = t==='expense'?'#181715':'#fff';
    document.getElementById('btn-t-exp').style.color = t==='expense'?'#fff':'#181715';
    document.getElementById('btn-t-inc').style.background = t==='income'?'#181715':'#fff';
    document.getElementById('btn-t-inc').style.color = t==='income'?'#fff':'#181715';
    document.getElementById('tx-category').style.display = t==='expense'?'block':'none';
}

function openAccountSheet() { document.getElementById('overlay-account').classList.add('open'); }
function saveNewAccount() {
    const id = 'a' + Date.now();
    state.accounts.push({ id, name: document.getElementById('acc-name').value, emoji: document.getElementById('acc-emoji').value || 'üè¶' });
    const b = parseFloat(document.getElementById('acc-balance').value) || 0;
    if(b!==0) state.transactions.push({ type:'income', concept:'Saldo Inicial', amount: b, date: new Date().toISOString().split('T')[0], accountId: id });
    document.getElementById('overlay-account').classList.remove('open');
    save();
}

function openGroupSheet() { document.getElementById('overlay-group').classList.add('open'); }
function saveNewGroup() {
    state.groups.push({ id: 'g'+Date.now(), name: document.getElementById('group-name').value, cats: [] });
    document.getElementById('overlay-group').classList.remove('open');
    save();
}

function openCatSheet(gid) { activeGroupId = gid; document.getElementById('overlay-cat').classList.add('open'); }
function saveNewCat() {
    const g = state.groups.find(x => x.id === activeGroupId);
    g.cats.push({ id: 'c'+Date.now(), name: document.getElementById('cat-name').value, emoji: document.getElementById('cat-emoji').value || 'üìå' });
    document.getElementById('overlay-cat').classList.remove('open');
    save();
}

function changeMonth(d) { state.currentMonthDate.setMonth(state.currentMonthDate.getMonth() + d); render(); }
function showPanel(id, btn) {
    document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
    document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
    document.getElementById('panel-'+id).classList.add('active');
    btn.classList.add('active');
}

// Iniciar
render();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>é–“ â€” Ma Budget</title>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,500;1,300;1,400&family=Zen+Kaku+Gothic+New:wght@300;400;500&display=swap" rel="stylesheet">
<style>
  :root {
    /* Paleta Oscura (Top & Bottom) */
    --bg-dark: #181715;
    --bg-pill: #2C2B28;
    --text-gold: #C2A878;
    --text-green: #8DA980;
    
    /* Paleta Verde (Banner) */
    --bg-banner: #4B6342;
    --text-banner-light: #C8D8BF;
    
    /* Paleta Clara (Lista) */
    --bg-list-header: #EBE6DA;
    --bg-card: #FDFBF7;
    --bg-card-active: #F4EFE6;
    
    /* Textos Generales */
    --text-main: #1C1C1A;
    --text-muted: #6B6B65;
    --border: rgba(28,28,26,0.06);
    --border-dark: rgba(255,255,255,0.05);
    
    /* Alertas */
    --aka: #B04A4A;
  }

  * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color: transparent; }
  html, body { height: 100%; overflow: hidden; }

  body {
    font-family: 'Zen Kaku Gothic New', sans-serif;
    background: var(--bg-list-header);
    color: var(--text-main);
    font-weight: 400;
    font-size: 15px;
  }

  .app {
    display: flex;
    flex-direction: column;
    height: 100%;
    max-width: 480px;
    margin: 0 auto;
    background: var(--bg-list-header);
    position: relative;
  }

  /* â”€â”€ TOP HEADER (DARK) â”€â”€ */
  .top-header {
    background: var(--bg-dark);
    padding: 48px 20px 16px;
    flex-shrink: 0;
  }

  .top-bar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 24px;
  }

  .logo {
    font-family: 'Cormorant Garamond', serif;
    font-size: 24px;
    font-weight: 300;
    color: var(--text-gold);
    letter-spacing: 0.12em;
  }

  .month-nav {
    display: flex;
    align-items: center;
    background: var(--bg-pill);
    border-radius: 20px;
    padding: 2px 4px;
  }

  .month-btn {
    background: none; border: none;
    color: rgba(255,255,255,0.5);
    width: 30px; height: 30px;
    font-size: 16px; cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    transition: color 0.2s;
  }
  .month-btn:active { color: white; }

  .month-label {
    font-family: 'Zen Kaku Gothic New', sans-serif;
    font-size: 13px; color: rgba(255,255,255,0.85);
    letter-spacing: 0.04em;
    padding: 0 8px;
    min-width: 100px; text-align: center;
  }

  .header-btn {
    width: 32px; height: 32px;
    background: var(--bg-pill);
    border: none; border-radius: 50%;
    color: rgba(255,255,255,0.7);
    font-size: 16px; font-weight: 300; cursor: pointer;
    display: flex; align-items: center; justify-content: center;
  }

  .summary-pills {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 8px;
  }

  .pill {
    background: var(--bg-pill);
    border-radius: 12px;
    padding: 12px 8px;
    text-align: center;
  }

  .pill-label {
    font-size: 9px; letter-spacing: 0.1em;
    text-transform: uppercase;
    color: rgba(255,255,255,0.4);
    margin-bottom: 6px; display: block;
  }

  .pill-value {
    font-family: 'Cormorant Garamond', serif;
    font-size: 18px; font-weight: 400;
    color: rgba(255,255,255,0.85);
    letter-spacing: 0.02em;
  }
  .pill-value.gold { color: var(--text-gold); }
  .pill-value.green { color: var(--text-green); }

  /* â”€â”€ ASSIGN BANNER (GREEN) â”€â”€ */
  .assign-banner {
    background: var(--bg-banner);
    padding: 16px 20px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-shrink: 0;
  }

  .assign-left { display: flex; flex-direction: column; gap: 4px; }
  .assign-label { font-size: 9px; letter-spacing: 0.12em; text-transform: uppercase; color: var(--text-banner-light); opacity: 0.8; }
  .assign-value { font-family: 'Cormorant Garamond', serif; font-size: 26px; color: var(--text-banner-light); font-weight: 400; }
  .assign-value.zero { color: rgba(255,255,255,0.9); }

  .assign-age {
    background: rgba(0,0,0,0.15);
    border-radius: 16px; padding: 6px 16px;
    text-align: center;
  }
  .assign-age-num { font-family: 'Cormorant Garamond', serif; font-size: 20px; color: white; line-height: 1; margin-bottom: 2px;}
  .assign-age-label { font-size: 8px; letter-spacing: 0.1em; text-transform: uppercase; color: rgba(255,255,255,0.6); }

  /* â”€â”€ CONTENT (LIGHT) â”€â”€ */
  .content {
    flex: 1;
    overflow-y: auto;
    overflow-x: hidden;
    padding-bottom: 100px; /* Space for FAB and Nav */
    background: var(--bg-list-header);
  }

  .panel { display: none; }
  .panel.active { display: block; }

  /* â”€â”€ BUDGET LIST â”€â”€ */
  .budget-col-header {
    display: grid;
    grid-template-columns: 1fr 80px 80px;
    padding: 14px 20px 10px;
    position: sticky; top: 0;
    background: var(--bg-list-header); z-index: 5;
    border-bottom: 1px solid rgba(0,0,0,0.05);
  }
  .bch { font-size: 9px; letter-spacing: 0.12em; text-transform: uppercase; color: var(--text-muted); }
  .bch:not(:first-child) { text-align: right; }

  .group-row {
    display: grid;
    grid-template-columns: 1fr 80px 80px;
    padding: 12px 20px;
    background: var(--bg-list-header);
    align-items: center;
    cursor: pointer;
    user-select: none;
    border-top: 1px solid rgba(0,0,0,0.03);
  }

  .group-title {
    display: flex; align-items: center; gap: 6px;
    font-size: 10px; font-weight: 500;
    letter-spacing: 0.1em; text-transform: uppercase;
    color: var(--text-muted);
  }

  .chevron { font-size: 9px; transition: transform 0.2s; opacity: 0.6; }
  .group-row.closed .chevron { transform: rotate(-90deg); }

  .group-num {
    font-size: 13px; color: var(--text-muted); text-align: right;
  }

  .cat-rows.hidden { display: none; }

  .cat-row {
    display: grid;
    grid-template-columns: 1fr 80px 80px;
    padding: 14px 20px 14px 30px;
    align-items: center;
    background: var(--bg-card);
    border-top: 1px solid var(--border);
    cursor: pointer;
  }
  .cat-row:active { background: var(--bg-card-active); }

  .cat-info { display: flex; align-items: center; gap: 12px; min-width: 0; }
  .cat-emo { font-size: 18px; flex-shrink: 0; }
  .cat-text { min-width: 0; flex: 1; }
  .cat-name-text { font-size: 14px; color: var(--text-main); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  
  .cat-bar { height: 2px; background: #E6E2D8; border-radius: 1px; margin-top: 4px; overflow: hidden; max-width: 80%; }
  .cat-bar-fill { height: 100%; background: var(--bg-banner); border-radius: 1px; transition: width 0.3s; width: 0%; }
  .cat-bar-fill.over { background: var(--aka); }

  .cat-assigned {
    font-size: 14px; text-align: right;
    color: var(--text-muted);
    cursor: text; padding: 4px;
    border-radius: 6px; position: relative;
  }
  .cat-assigned:active { background: rgba(0,0,0,0.05); }

  .cat-avail {
    font-size: 14px; text-align: right; font-weight: 400; color: var(--text-muted);
  }
  .cat-avail.pos { color: var(--bg-banner); }
  .cat-avail.neg { color: var(--aka); }

  .add-cat-row {
    padding: 12px 20px 12px 30px;
    background: var(--bg-card);
    border-top: 1px solid var(--border);
    color: var(--text-muted);
    font-size: 13px;
    cursor: pointer;
  }
  .add-cat-row:active { background: var(--bg-card-active); }

  /* â”€â”€ BOTTOM NAV (DARK) â”€â”€ */
  .bottom-nav {
    position: fixed; bottom: 0; left: 50%;
    transform: translateX(-50%);
    width: 100%; max-width: 480px;
    background: var(--bg-dark);
    display: flex; z-index: 50;
    padding-bottom: env(safe-area-inset-bottom, 10px);
    border-top: 1px solid var(--border-dark);
  }

  .nav-tab {
    flex: 1; display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    padding: 12px 0;
    cursor: pointer; color: rgba(255,255,255,0.4);
    transition: color 0.15s; border: none; background: none;
    gap: 6px;
  }
  .nav-tab.active { color: var(--text-gold); }
  
  .nav-icon { font-size: 18px; line-height: 1; }
  .nav-label { font-size: 8px; letter-spacing: 0.1em; text-transform: uppercase; font-family: 'Zen Kaku Gothic New', sans-serif; }

  /* â”€â”€ FAB â”€â”€ */
  .fab {
    position: fixed; bottom: 85px;
    right: max(20px, calc(50% - 240px + 20px));
    width: 56px; height: 56px;
    background: var(--bg-banner);
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: 28px; color: white; cursor: pointer;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    border: none; z-index: 40;
    transition: transform 0.1s;
  }
  .fab:active { transform: scale(0.92); }

  /* â”€â”€ SHEET MODAL â”€â”€ */
  .overlay {
    position: fixed; inset: 0;
    background: rgba(0,0,0,0.6);
    z-index: 100;
    display: flex; align-items: flex-end;
    opacity: 0; pointer-events: none;
    transition: opacity 0.25s;
  }
  .overlay.open { opacity: 1; pointer-events: all; }

  .sheet {
    background: var(--bg-card);
    border-radius: 20px 20px 0 0;
    width: 100%; max-width: 480px; margin: 0 auto;
    padding: 24px;
    transform: translateY(100%);
    transition: transform 0.25s cubic-bezier(0.1, 0.8, 0.2, 1);
  }
  .overlay.open .sheet { transform: translateY(0); }

  .form-input {
    width: 100%; background: white;
    border: 1px solid var(--border); border-radius: 10px;
    padding: 14px; margin-bottom: 12px;
    font-family: 'Zen Kaku Gothic New', sans-serif;
    font-size: 15px; outline: none;
  }
  select.form-input {
    appearance: none;
    background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%236B6B65' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right 14px center;
    background-size: 16px;
  }
  .btn-save {
    width: 100%; background: var(--bg-banner);
    color: white; border: none; border-radius: 12px;
    padding: 16px; font-size: 15px; cursor: pointer;
    margin-top: 10px;
  }

</style>
</head>
<body>
<div class="app">

  <!-- TOP HEADER -->
  <div class="top-header">
    <div class="top-bar">
      <div class="logo">é–“ Ma</div>
      <div class="month-nav">
        <button class="month-btn" onclick="changeMonth(-1)">â€¹</button>
        <span class="month-label" id="monthLabel">Febrero 2026</span>
        <button class="month-btn" onclick="changeMonth(1)">â€º</button>
      </div>
      <button class="header-btn" onclick="openSheet()">+</button>
    </div>
    <div class="summary-pills">
      <div class="pill">
        <span class="pill-label">Asignado</span>
        <span class="pill-value" id="s-assigned">â‚¬0,00</span>
      </div>
      <div class="pill">
        <span class="pill-label">Gastado</span>
        <span class="pill-value gold" id="s-spent">â‚¬0,00</span>
      </div>
      <div class="pill">
        <span class="pill-label">Disponible</span>
        <span class="pill-value green" id="s-avail">â‚¬0,00</span>
      </div>
    </div>
  </div>

  <!-- ASSIGN BANNER -->
  <div class="assign-banner">
    <div class="assign-left">
      <span class="assign-label">Para asignar</span>
      <span class="assign-value zero" id="toAssignVal">â‚¬0,00</span>
    </div>
    <div class="assign-age">
      <div class="assign-age-num">0</div>
      <div class="assign-age-label">dÃ­as dinero</div>
    </div>
  </div>

  <!-- CONTENT -->
  <div class="content">
    <div class="panel active" id="panel-budget">
      <div class="budget-col-header">
        <span class="bch">CategorÃ­a</span>
        <span class="bch">Asignado</span>
        <span class="bch">Disponible</span>
      </div>
      <div id="budgetBody"></div>
    </div>
    
    <div class="panel" id="panel-mov">
      <div class="budget-col-header">
        <span class="bch">Fecha y Concepto</span>
        <span class="bch" style="text-align: right; grid-column: span 2;">Importe</span>
      </div>
      <div id="txBody"></div>
    </div>

    <div class="panel" id="panel-goals" style="padding: 40px 20px; text-align: center; color: var(--text-muted); font-size: 14px;">
      Tus metas financieras aparecerÃ¡n aquÃ­.
    </div>

    <div class="panel" id="panel-reports" style="padding: 40px 20px; text-align: center; color: var(--text-muted); font-size: 14px;">
      Los grÃ¡ficos e informes estarÃ¡n disponibles pronto.
    </div>
  </div>

  <!-- FAB -->
  <button class="fab" onclick="openTxSheet()">+</button>

  <!-- BOTTOM NAV -->
  <nav class="bottom-nav">
    <button class="nav-tab active" onclick="showPanel('budget', this)">
      <span class="nav-icon">âŠž</span>
      <span class="nav-label">Plan</span>
    </button>
    <button class="nav-tab" onclick="showPanel('mov', this)">
      <span class="nav-icon">â‰¡</span>
      <span class="nav-label">Movimientos</span>
    </button>
    <button class="nav-tab" onclick="showPanel('goals', this)">
      <span class="nav-icon">â—Ž</span>
      <span class="nav-label">Metas</span>
    </button>
    <button class="nav-tab" onclick="showPanel('reports', this)">
      <span class="nav-icon">â–¦</span>
      <span class="nav-label">Informes</span>
    </button>
  </nav>

</div>

<!-- OVERLAY SHEET PARA AÃ‘ADIR/EDITAR -->
<div class="overlay" id="overlay" onclick="closeSheet(event)">
  <div class="sheet" onclick="event.stopPropagation()">
    <h3 style="font-family: 'Cormorant Garamond'; margin-bottom: 20px; font-weight: 400; font-size: 22px;">Modificar Presupuesto</h3>
    <input type="text" id="inp-concept" class="form-input" placeholder="Concepto o CategorÃ­a" disabled>
    <input type="number" id="inp-amount" class="form-input" placeholder="0.00" step="0.01">
    <button class="btn-save" onclick="saveEdit()">Actualizar</button>
  </div>
</div>

<!-- OVERLAY SHEET PARA NUEVO MOVIMIENTO -->
<div class="overlay" id="overlay-tx" onclick="closeTxSheet(event)">
  <div class="sheet" onclick="event.stopPropagation()">
    <h3 style="font-family: 'Cormorant Garamond'; margin-bottom: 20px; font-weight: 400; font-size: 22px;">Nuevo Movimiento</h3>
    
    <div style="display: flex; gap: 10px; margin-bottom: 15px;">
      <button id="btn-type-exp" onclick="setTxType('expense')" style="flex:1; padding:10px; border-radius:8px; border:1px solid var(--border); background:var(--bg-card); color:var(--text-main); font-family: 'Zen Kaku Gothic New', sans-serif;">Gasto</button>
      <button id="btn-type-inc" onclick="setTxType('income')" style="flex:1; padding:10px; border-radius:8px; border:1px solid var(--border); background:var(--bg-list-header); color:var(--text-muted); font-family: 'Zen Kaku Gothic New', sans-serif;">Ingreso</button>
    </div>

    <div id="tx-error" style="color: var(--aka); font-size: 13px; margin-bottom: 10px; display: none;"></div>
    
    <input type="date" id="tx-date" class="form-input">
    <input type="text" id="tx-concept" class="form-input" placeholder="Concepto (ej. Supermercado)">
    <input type="number" id="tx-amount" class="form-input" placeholder="Importe â‚¬" step="0.01">
    
    <select id="tx-category" class="form-input">
      <option value="">Selecciona una categorÃ­a...</option>
    </select>

    <button class="btn-save" onclick="saveTx()">Guardar Movimiento</button>
  </div>
</div>

<script>
// ESTADO INICIAL A CERO
const state = {
  month: new Date(2026, 1, 1), // Febrero 2026
  income: 0,
  transactions: [],
  groups: [
    { id:'g1', name:'Gastos esenciales', open:true, cats:[
      { id:'c1', name:'Alquiler',          emoji:'ðŸ ', assigned:0, spent:0 },
      { id:'c2', name:'Suministros',       emoji:'ðŸ’¡', assigned:0, spent:0 },
      { id:'c3', name:'Supermercado',      emoji:'ðŸ›’', assigned:0, spent:0 },
      { id:'c4', name:'Transporte',        emoji:'ðŸš‡', assigned:0, spent:0 },
      { id:'c5', name:'TelÃ©fono/Internet', emoji:'ðŸ“¡', assigned:0, spent:0 },
    ]},
    { id:'g2', name:'Estilo de vida', open:true, cats:[
      { id:'c6', name:'Restaurantes', emoji:'ðŸœ', assigned:0, spent:0 },
      { id:'c7', name:'Ocio',         emoji:'ðŸŽ­', assigned:0, spent:0 },
    ]}
  ]
};

const MONTHS = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
const fmt  = n => 'â‚¬' + Math.abs(n).toFixed(2).replace('.',',');
let editingCatId = null;

function renderBudget() {
  const body = document.getElementById('budgetBody');
  body.innerHTML = '';
  
  let totalAssigned = 0;
  let totalSpent = 0;

  for(const group of state.groups) {
    const gAssigned = group.cats.reduce((s,c) => s + c.assigned, 0);
    const gSpent    = group.cats.reduce((s,c) => s + c.spent, 0);
    const gAvail    = gAssigned - gSpent;
    
    totalAssigned += gAssigned;
    totalSpent += gSpent;

    const wrapper = document.createElement('div');
    wrapper.innerHTML = `
      <div class="group-row ${group.open?'open':'closed'}" onclick="toggleGroup('${group.id}')">
        <div class="group-title"><span class="chevron">â–¾</span>${group.name}</div>
        <div class="group-num">â‚¬${gAssigned.toFixed(2).replace('.',',')}</div>
        <div class="group-num">â‚¬${gAvail.toFixed(2).replace('.',',')}</div>
      </div>
      <div class="cat-rows ${group.open?'':'hidden'}" id="cr-${group.id}"></div>
    `;
    body.appendChild(wrapper);

    const rows = wrapper.querySelector('.cat-rows');
    for(const cat of group.cats) {
      const avail = cat.assigned - cat.spent;
      const pct   = cat.assigned > 0 ? Math.min((cat.spent / cat.assigned) * 100, 100) : 0;
      
      const row = document.createElement('div');
      row.className = 'cat-row';
      row.innerHTML = `
        <div class="cat-info">
          <span class="cat-emo">${cat.emoji}</span>
          <div class="cat-text">
            <div class="cat-name-text">${cat.name}</div>
            <div class="cat-bar"><div class="cat-bar-fill" style="width:${pct}%"></div></div>
          </div>
        </div>
        <div class="cat-assigned" onclick="editAssigned('${cat.id}', '${cat.name}', ${cat.assigned})">
          â‚¬${cat.assigned.toFixed(2).replace('.',',')}
        </div>
        <div class="cat-avail ${avail>0 ? 'pos' : (avail<0 ? 'neg' : '')}">
          â‚¬${avail.toFixed(2).replace('.',',')}
        </div>
      `;
      rows.appendChild(row);
    }

    const addRow = document.createElement('div');
    addRow.className = 'add-cat-row';
    addRow.textContent = '+ aÃ±adir categorÃ­a';
    rows.appendChild(addRow);
  }

  // Update Headers
  const totalAvail = totalAssigned - totalSpent;
  const toAssign = state.income - totalAssigned;

  document.getElementById('s-assigned').textContent = fmt(totalAssigned);
  document.getElementById('s-spent').textContent = fmt(totalSpent);
  document.getElementById('s-avail').textContent = fmt(totalAvail);
  document.getElementById('toAssignVal').textContent = fmt(toAssign);
}

function toggleGroup(id) {
  const g = state.groups.find(g => g.id === id);
  if(g) {
    g.open = !g.open;
    renderBudget();
  }
}

function updateMonth() {
  document.getElementById('monthLabel').textContent = MONTHS[state.month.getMonth()] + ' ' + state.month.getFullYear();
}

function changeMonth(d) {
  state.month = new Date(state.month.getFullYear(), state.month.getMonth()+d, 1);
  updateMonth();
}

function showPanel(id, btn) {
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
  document.getElementById('panel-' + id).classList.add('active');
  btn.classList.add('active');
}

/* Modals */
function openSheet() {
  document.getElementById('overlay').classList.add('open');
}
function closeSheet(e) {
  if(!e || e.target.id === 'overlay') {
    document.getElementById('overlay').classList.remove('open');
    editingCatId = null;
  }
}

function editAssigned(id, name, currentAmount) {
  editingCatId = id;
  document.getElementById('inp-concept').value = "Asignar a: " + name;
  document.getElementById('inp-amount').value = currentAmount;
  openSheet();
}

function saveEdit() {
  if (editingCatId) {
    const val = parseFloat(document.getElementById('inp-amount').value) || 0;
    // Find category and update
    for(const g of state.groups) {
      const cat = g.cats.find(c => c.id === editingCatId);
      if(cat) {
        cat.assigned = val;
        break;
      }
    }
    renderBudget();
  } else {
    // Si no hay categorÃ­a editÃ¡ndose, asumimos que estamos aÃ±adiendo ingresos
    const val = parseFloat(document.getElementById('inp-amount').value) || 0;
    state.income += val;
    renderBudget();
  }
  closeSheet();
}

/* LOGICA DE MOVIMIENTOS */
let currentTxType = 'expense';

function setTxType(type) {
  currentTxType = type;
  const btnExp = document.getElementById('btn-type-exp');
  const btnInc = document.getElementById('btn-type-inc');
  const catSelect = document.getElementById('tx-category');
  
  document.getElementById('tx-error').style.display = 'none';

  if (type === 'expense') {
    btnExp.style.background = 'var(--aka)';
    btnExp.style.color = 'white';
    btnExp.style.borderColor = 'var(--aka)';
    btnInc.style.background = 'var(--bg-list-header)';
    btnInc.style.color = 'var(--text-muted)';
    btnInc.style.borderColor = 'var(--border)';
    catSelect.style.display = 'block';
  } else {
    btnInc.style.background = 'var(--bg-banner)';
    btnInc.style.color = 'white';
    btnInc.style.borderColor = 'var(--bg-banner)';
    btnExp.style.background = 'var(--bg-list-header)';
    btnExp.style.color = 'var(--text-muted)';
    btnExp.style.borderColor = 'var(--border)';
    catSelect.style.display = 'none';
  }
}

function openTxSheet() {
  document.getElementById('tx-date').valueAsDate = new Date();
  document.getElementById('tx-concept').value = '';
  document.getElementById('tx-amount').value = '';
  document.getElementById('tx-error').style.display = 'none';
  
  const catSelect = document.getElementById('tx-category');
  catSelect.innerHTML = '<option value="">Selecciona una categorÃ­a...</option>';
  for(const g of state.groups) {
    const optgroup = document.createElement('optgroup');
    optgroup.label = g.name;
    for(const cat of g.cats) {
      const opt = document.createElement('option');
      opt.value = cat.id;
      opt.textContent = `${cat.emoji} ${cat.name}`;
      optgroup.appendChild(opt);
    }
    catSelect.appendChild(optgroup);
  }
  
  setTxType('expense');
  document.getElementById('overlay-tx').classList.add('open');
}

function closeTxSheet(e) {
  if(!e || e.target.id === 'overlay-tx') {
    document.getElementById('overlay-tx').classList.remove('open');
  }
}

function saveTx() {
  const concept = document.getElementById('tx-concept').value.trim();
  const amount = parseFloat(document.getElementById('tx-amount').value);
  const date = document.getElementById('tx-date').value;
  const catId = document.getElementById('tx-category').value;
  const errBox = document.getElementById('tx-error');

  if (!concept || isNaN(amount) || amount <= 0) {
    errBox.textContent = "Por favor, introduce un concepto y un importe vÃ¡lido.";
    errBox.style.display = 'block';
    return;
  }

  if (currentTxType === 'expense' && !catId) {
    errBox.textContent = "Por favor, selecciona una categorÃ­a para el gasto.";
    errBox.style.display = 'block';
    return;
  }

  errBox.style.display = 'none';

  const tx = {
    id: 'tx-' + Date.now(),
    type: currentTxType,
    concept,
    amount,
    date,
    categoryId: currentTxType === 'expense' ? catId : null
  };

  state.transactions.push(tx);
  state.transactions.sort((a, b) => new Date(b.date) - new Date(a.date));

  if (currentTxType === 'expense') {
    for(const g of state.groups) {
      const cat = g.cats.find(c => c.id === catId);
      if (cat) {
        cat.spent += amount;
        break;
      }
    }
  } else {
    state.income += amount;
  }

  renderBudget();
  renderTransactions();
  closeTxSheet();
}

function renderTransactions() {
  const body = document.getElementById('txBody');
  body.innerHTML = '';

  if (state.transactions.length === 0) {
    body.innerHTML = '<div style="padding: 40px 20px; text-align: center; color: var(--text-muted); font-size: 14px;">AÃºn no hay movimientos registrados.</div>';
    return;
  }

  for(const tx of state.transactions) {
    let catName = 'Ingreso';
    let catEmoji = 'ðŸ’°';
    let amountClass = 'pos';
    let prefix = '+';

    if (tx.type === 'expense') {
      amountClass = 'neg';
      prefix = '-';
      for(const g of state.groups) {
        const cat = g.cats.find(c => c.id === tx.categoryId);
        if(cat) {
          catName = cat.name;
          catEmoji = cat.emoji;
          break;
        }
      }
    }

    const dateObj = new Date(tx.date);
    const dateStr = dateObj.toLocaleDateString('es-ES', { day: '2-digit', month: 'short', year: 'numeric' });

    const row = document.createElement('div');
    row.className = 'cat-row';
    row.style.gridTemplateColumns = '1fr auto';
    
    row.innerHTML = `
      <div class="cat-info">
        <span class="cat-emo">${catEmoji}</span>
        <div class="cat-text">
          <div class="cat-name-text" style="font-weight: 500;">${tx.concept}</div>
          <div style="font-size: 11px; color: var(--text-muted); margin-top: 2px;">${dateStr} Â· ${catName}</div>
        </div>
      </div>
      <div class="cat-avail ${amountClass}" style="font-size: 16px; align-self: center;">
        ${prefix}â‚¬${tx.amount.toFixed(2).replace('.',',')}
      </div>
    `;
    body.appendChild(row);
  }
}

// Inicializar
updateMonth();
renderBudget();
renderTransactions();
</script>
</body>
</html>



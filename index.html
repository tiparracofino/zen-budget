<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Èñì ‚Äî Ma Budget</title>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,500;1,300&family=Zen+Kaku+Gothic+New:wght@300;400;500;700&display=swap" rel="stylesheet">
<style>
  :root {
    --bg-dark: #181715; --bg-pill: #2C2B28; --text-gold: #C2A878;
    --bg-banner: #4B6342; --text-banner-light: #C8D8BF;
    --bg-list-header: #EBE6DA; --bg-card: #FDFBF7; --text-main: #1C1C1A;
    --text-muted: #6B6B65; --border: rgba(28,28,26,0.06); 
    --aka: #B04A4A; --edit-blue: #C2A878;
  }

  * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color: transparent; }
  body { font-family: 'Zen Kaku Gothic New', sans-serif; background: var(--bg-list-header); color: var(--text-main); height: 100vh; overflow: hidden; }

  .app { display: flex; flex-direction: column; height: 100%; max-width: 480px; margin: 0 auto; background: var(--bg-list-header); position: relative; }

  /* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
  .top-header { background: var(--bg-dark); padding: 48px 20px 16px; flex-shrink: 0; }
  .top-bar { display: flex; align-items: center; justify-content: space-between; margin-bottom: 24px; }
  .logo { font-family: 'Cormorant Garamond', serif; font-size: 24px; color: var(--text-gold); letter-spacing: 0.12em; }
  .month-nav { display: flex; align-items: center; background: var(--bg-pill); border-radius: 20px; padding: 2px 4px; }
  .month-btn { background: none; border: none; color: rgba(255,255,255,0.6); width: 30px; height: 30px; font-size: 16px; cursor: pointer; }
  .month-label { font-size: 13px; color: rgba(255,255,255,0.9); min-width: 110px; text-align: center; text-transform: capitalize;}
  
  .summary-pills { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; }
  .pill { background: var(--bg-pill); border-radius: 12px; padding: 12px 8px; text-align: center; }
  .pill-label { font-size: 8px; text-transform: uppercase; color: rgba(255,255,255,0.4); margin-bottom: 4px; display: block; }
  .pill-value { font-family: 'Cormorant Garamond', serif; font-size: 16px; color: rgba(255,255,255,0.85); }
  .pill-value.neg-red { color: var(--aka) !important; font-weight: 600; }

  .assign-banner { background: var(--bg-banner); padding: 16px 20px; display: flex; align-items: center; justify-content: space-between; transition: background 0.3s;}
  .assign-banner.warning { background: var(--aka); }
  .assign-value { font-family: 'Cormorant Garamond', serif; font-size: 24px; color: var(--text-banner-light); }

  /* ‚îÄ‚îÄ CONTENT ‚îÄ‚îÄ */
  .content { flex: 1; overflow-y: auto; padding-bottom: 110px; -webkit-overflow-scrolling: touch; }
  .panel { display: none; }
  .panel.active { display: block; }

  /* ‚îÄ‚îÄ SWIPE GESTURES ‚îÄ‚îÄ */
  .swipe-container { position: relative; overflow: hidden; background: var(--bg-card); border-bottom: 1px solid var(--border); touch-action: pan-y; }
  .swipe-actions { position: absolute; inset: 0; display: flex; justify-content: flex-end; align-items: stretch; }
  .action-delete { background: var(--aka); color: white; width: 80px; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: 700; cursor: pointer; }
  .swipe-content { position: relative; z-index: 2; background: var(--bg-card); padding: 16px 20px; display: flex; align-items: center; transition: transform 0.3s ease; }

  /* ‚îÄ‚îÄ ROWS & GROUPS ‚îÄ‚îÄ */
  .group-header { background: var(--bg-list-header); padding: 12px 20px; font-size: 10px; text-transform: uppercase; color: var(--text-muted); display: flex; justify-content: space-between; align-items: center; font-weight: 700; letter-spacing: 0.1em; cursor: pointer; }
  .cat-list { transition: all 0.3s; }
  .cat-list.hidden { display: none; }
  
  .row-info { display: flex; align-items: center; gap: 12px; flex: 1; }
  .val-box { text-align: right; min-width: 70px; }

  /* ‚îÄ‚îÄ NAV ‚îÄ‚îÄ */
  .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: var(--bg-dark); display: flex; padding-bottom: env(safe-area-inset-bottom); z-index: 50; }
  .nav-tab { flex: 1; display: flex; flex-direction: column; align-items: center; padding: 12px 0; color: rgba(255,255,255,0.4); background: none; border: none; cursor: pointer; }
  .nav-tab.active { color: var(--text-gold); }
  .nav-label { font-size: 8px; text-transform: uppercase; margin-top: 4px; }

  .fab { position: fixed; bottom: 85px; right: 20px; width: 56px; height: 56px; background: var(--bg-banner); border-radius: 50%; color: white; font-size: 24px; border: none; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 40; cursor: pointer; }

  /* ‚îÄ‚îÄ MODALS ‚îÄ‚îÄ */
  .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); display: none; align-items: flex-end; z-index: 100; }
  .overlay.open { display: flex; }
  .sheet { background: var(--bg-card); width: 100%; padding: 24px; border-radius: 20px 20px 0 0; max-height: 85vh; overflow-y: auto;}
  .form-input { width: 100%; padding: 14px; margin-bottom: 12px; border: 1px solid var(--border); border-radius: 10px; font-size: 15px; background: white;}
  .form-input:focus { outline: none; border-color: var(--text-gold); }
  .btn-save { width: 100%; padding: 16px; background: var(--bg-banner); color: white; border: none; border-radius: 12px; font-size: 16px; cursor: pointer; margin-top: 10px;}
  
  .toast { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%); background: var(--bg-dark); color: white; padding: 10px 20px; border-radius: 8px; opacity: 0; z-index: 200; pointer-events: none; transition: 0.3s; font-size: 13px;}
  .toast.show { opacity: 1; }
</style>
</head>
<body>

<div class="app">
  <div class="top-header">
    <div class="top-bar">
      <div class="logo">Èñì Ma</div>
      <div class="month-nav">
        <button class="month-btn" onclick="changeMonth(-1)">‚Äπ</button>
        <span class="month-label" id="monthLabel"></span>
        <button class="month-btn" onclick="changeMonth(1)">‚Ä∫</button>
      </div>
      <div style="width:24px"></div>
    </div>
    <div class="summary-pills">
      <div class="pill"><span class="pill-label">Asignado</span><span class="pill-value" id="s-assigned"></span></div>
      <div class="pill"><span class="pill-label">Actividad</span><span class="pill-value" id="s-spent"></span></div>
      <div class="pill"><span class="pill-label">Disponible</span><span class="pill-value" id="s-avail"></span></div>
    </div>
  </div>

  <div class="assign-banner" id="banner-assign">
    <div>
      <div style="font-size: 9px; text-transform: uppercase; color: var(--text-banner-light); opacity: 0.7">Listo para asignar</div>
      <div style="font-size: 8px; color: var(--text-banner-light); opacity: 0.5">Balance global simulado</div>
    </div>
    <div class="assign-value" id="toAssignVal"></div>
  </div>

  <div class="content">
    <div class="panel active" id="panel-budget"></div>
    <div class="panel" id="panel-mov"></div>
    <div class="panel" id="panel-manage">
      <div class="group-header">CUENTAS <button onclick="openAddAccount()" style="color:var(--text-gold); border:none; background:none; font-size:16px; cursor:pointer">+</button></div>
      <div id="manage-accounts-list"></div>
      
      <div class="group-header" style="margin-top:20px">ESTRUCTURA <button onclick="openAddGroup()" style="color:var(--text-gold); border:none; background:none; font-size:11px; cursor:pointer">+ GRUPO</button></div>
      <div id="manage-structure-list"></div>
    </div>
  </div>

  <button class="fab" onclick="openTxSheet()">+</button>
  
  <nav class="bottom-nav">
    <button class="nav-tab active" onclick="showPanel('budget', this)">‚äû<span class="nav-label">Plan</span></button>
    <button class="nav-tab" onclick="showPanel('mov', this)">‚â°<span class="nav-label">Mov</span></button>
    <button class="nav-tab" onclick="showPanel('manage', this)">üè¶<span class="nav-label">Gestionar</span></button>
  </nav>
</div>

<div id="toast" class="toast"></div>

<div class="overlay" id="overlay-main" onclick="closeModal()">
    <div class="sheet" onclick="event.stopPropagation()" id="modal-content"></div>
</div>

<script>
// --- DATOS Y ESTADO ---
const STORAGE_KEY = 'MA_DATA_V7_PRO';
let state = JSON.parse(localStorage.getItem(STORAGE_KEY)) || {
    transactions: [],
    assignments: {}, // formato: {"2023-10": {"c1": 100, "c2": 50}}
    accounts: [{ id: 'a1', name: 'Cuenta Principal', emoji: 'üè¶' }],
    groups: [{ id: 'g1', name: 'Gastos Fijos', open: true, cats: [{ id: 'c1', name: 'Comida', emoji: 'üõí' }] }]
};
let currentDate = new Date();

const uid = () => 'id_' + Math.random().toString(36).substr(2, 9);
const fmt = (n) => new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR' }).format(n);
const getMStr = (d) => `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
const showToast = (m) => { const t = document.getElementById('toast'); t.textContent = m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 2000); }
const save = () => { localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); renderAll(); }

// --- MOTOR DE C√ÅLCULO DE SIMULACI√ìN FUTURA ---
// 1. Calcular "Para Asignar" global (Ingresos totales - Asignaciones de TODOS los meses)
function getGlobalToAssign() {
    let totalIncome = state.transactions
        .filter(t => t.type === 'income' && !t.categoryId) // Ingresos puros sin categor√≠a
        .reduce((sum, t) => sum + t.amount, 0);
        
    let totalAssigned = 0;
    Object.values(state.assignments).forEach(monthMap => {
        Object.values(monthMap).forEach(val => totalAssigned += val);
    });
    
    return totalIncome - totalAssigned;
}

// 2. Calcular el disponible de una categor√≠a ACUMULADO hasta el mes actual visualizado
function getCategoryAvailable(catId, targetMonthStr) {
    let assignedSoFar = 0;
    Object.keys(state.assignments).forEach(m => {
        if (m <= targetMonthStr) assignedSoFar += (state.assignments[m][catId] || 0);
    });

    let activitySoFar = 0;
    state.transactions.forEach(t => {
        if (t.categoryId === catId && getMStr(new Date(t.date)) <= targetMonthStr) {
            // Gasto resta del bote, Ingreso a categor√≠a (devoluci√≥n) suma al bote
            activitySoFar += (t.type === 'expense' ? -t.amount : t.amount);
        }
    });

    return assignedSoFar + activitySoFar;
}

// --- L√ìGICA DE DESLIZAR (SWIPE TO DELETE) ---
let startX = 0, currentX = 0, activeEl = null;
function ts(e) { startX = e.touches[0].clientX; activeEl = e.currentTarget.querySelector('.swipe-content'); activeEl.style.transition = 'none'; }
function tm(e) { 
    if(!activeEl) return;
    currentX = e.touches[0].clientX - startX;
    if(currentX < 0) activeEl.style.transform = `translateX(${Math.max(-80, currentX)}px)`; // Solo deslizar a la izquierda
}
function te(e) {
    if(!activeEl) return;
    activeEl.style.transition = 'transform 0.3s ease';
    if(currentX < -40) activeEl.style.transform = 'translateX(-80px)'; // Queda abierto
    else activeEl.style.transform = 'translateX(0)'; // Se cierra
    activeEl = null;
}

// --- RENDERIZADO GLOBAL ---
function renderAll() {
    const mStr = getMStr(currentDate);
    document.getElementById('monthLabel').textContent = currentDate.toLocaleString('es-ES', { month: 'long', year: 'numeric' });

    // RENDER: PANEL BUDGET
    const budgetPanel = document.getElementById('panel-budget');
    budgetPanel.innerHTML = '';
    let mAssigned = 0, mActivity = 0;

    state.groups.forEach(g => {
        // Cabecera del grupo
        budgetPanel.innerHTML += `<div class="group-header" onclick="toggleGroup('${g.id}')"><span>${g.open ? '‚ñæ' : '‚ñ∏'} ${g.name}</span></div>`;
        
        const list = document.createElement('div');
        list.className = 'cat-list' + (g.open ? '' : ' hidden');
        
        g.cats.forEach(c => {
            let assigned = (state.assignments[mStr] && state.assignments[mStr][c.id]) || 0;
            let avail = getCategoryAvailable(c.id, mStr);
            
            // Actividad SOLO de este mes
            let activityThisMonth = state.transactions
                .filter(t => t.categoryId === c.id && getMStr(new Date(t.date)) === mStr)
                .reduce((acc, t) => t.type === 'expense' ? acc + t.amount : acc - t.amount, 0);

            mAssigned += assigned;
            mActivity += activityThisMonth;

            list.innerHTML += `
                <div class="swipe-content" style="border-bottom:1px solid var(--border); cursor:pointer;" onclick="openAssignDialog('${c.id}','${c.name}',${assigned})">
                    <div class="row-info"><span>${c.emoji}</span><span style="font-size:14px">${c.name}</span></div>
                    <div class="val-box" style="color:var(--text-muted); font-size:12px">${fmt(assigned)}</div>
                    <div class="val-box ${avail < 0 ? 'neg-red' : ''}" style="font-size:15px; font-weight:500; color:${avail < 0 ? 'var(--aka)' : 'var(--bg-banner)'}">${fmt(avail)}</div>
                </div>`;
        });
        budgetPanel.appendChild(list);
    });

    // Actualizar Resumen Superior
    document.getElementById('s-assigned').textContent = fmt(mAssigned);
    document.getElementById('s-spent').textContent = fmt(mActivity); // Positivo es gasto
    document.getElementById('s-avail').textContent = fmt(mAssigned - mActivity);

    // Actualizar "Para Asignar" global
    const globalToAssign = getGlobalToAssign();
    const banner = document.getElementById('banner-assign');
    document.getElementById('toAssignVal').textContent = fmt(globalToAssign);
    if(globalToAssign < 0) { banner.classList.add('warning'); } else { banner.classList.remove('warning'); }

    // RENDER: PANEL MOVIMIENTOS
    const movPanel = document.getElementById('panel-mov');
    const monthTxs = state.transactions
        .filter(t => getMStr(new Date(t.date)) === mStr)
        .sort((a, b) => new Date(b.date) - new Date(a.date));

    movPanel.innerHTML = monthTxs.length ? '' : '<div style="padding:40px; text-align:center; color:var(--text-muted); font-size:14px">No hay movimientos en este mes</div>';

    monthTxs.forEach(t => {
        const acc = state.accounts.find(a => a.id === t.accountId);
        const isExp = t.type === 'expense';
        let catName = "General (Para Asignar)";
        if(t.categoryId) {
            state.groups.forEach(g => { const c = g.cats.find(x => x.id === t.categoryId); if(c) catName = c.name; });
        }

        movPanel.innerHTML += `
            <div class="swipe-container" ontouchstart="ts(event)" ontouchmove="tm(event)" ontouchend="te(event)">
                <div class="swipe-actions"><div class="action-delete" onclick="deleteTx('${t.id}')">BORRAR</div></div>
                <div class="swipe-content" style="padding: 12px 20px;">
                    <div class="row-info">
                        <div style="display:flex; flex-direction:column">
                            <span style="font-size:14px;">${t.concept || 'Movimiento'}</span>
                            <span style="font-size:11px; color:var(--text-muted)">${t.date} ‚Ä¢ ${acc?acc.name:'?'} ‚Ä¢ ${catName}</span>
                        </div>
                    </div>
                    <div class="val-box" style="font-size:15px; font-weight:500; color:${isExp ? 'var(--aka)' : 'var(--bg-banner)'}">
                        ${isExp ? '-' : '+'}${fmt(t.amount)}
                    </div>
                </div>
            </div>`;
    });

    // RENDER: PANEL GESTI√ìN
    const accPanel = document.getElementById('manage-accounts-list');
    accPanel.innerHTML = '';
    state.accounts.forEach(a => {
        let bal = state.transactions.filter(t=>t.accountId===a.id).reduce((s,t)=>s+(t.type==='income'?t.amount:-t.amount), 0);
        accPanel.innerHTML += `<div class="swipe-container" ontouchstart="ts(event)" ontouchmove="tm(event)" ontouchend="te(event)">
            <div class="swipe-actions"><div class="action-delete" onclick="deleteAcc('${a.id}')">BORRAR</div></div>
            <div class="swipe-content"><div class="row-info">${a.emoji} ${a.name}</div><div class="val-box" style="font-size:14px">${fmt(bal)}</div></div>
        </div>`;
    });

    const structPanel = document.getElementById('manage-structure-list');
    structPanel.innerHTML = '';
    state.groups.forEach(g => {
        structPanel.innerHTML += `<div class="swipe-container" ontouchstart="ts(event)" ontouchmove="tm(event)" ontouchend="te(event)">
            <div class="swipe-actions"><div class="action-delete" onclick="deleteGroup('${g.id}')">BORRAR</div></div>
            <div class="swipe-content" style="background:var(--bg-list-header); font-weight:700; font-size:11px">
                <div class="row-info">${g.name}</div>
                <button onclick="openAddCat('${g.id}')" style="background:none; border:none; color:var(--text-gold); cursor:pointer;">+ CAT</button>
            </div>
        </div>`;
        g.cats.forEach(c => {
            structPanel.innerHTML += `
                <div class="swipe-container" ontouchstart="ts(event)" ontouchmove="tm(event)" ontouchend="te(event)">
                    <div class="swipe-actions"><div class="action-delete" onclick="deleteCat('${c.id}')">BORRAR</div></div>
                    <div class="swipe-content"><div class="row-info">${c.emoji} ${c.name}</div></div>
                </div>`;
        });
    });
}

// --- ACCIONES Y MODALES ---
function toggleGroup(id) {
    let g = state.groups.find(x => x.id === id);
    if(g) g.open = !g.open;
    renderAll();
}

function changeMonth(d) { 
    currentDate.setMonth(currentDate.getMonth() + d); 
    renderAll(); 
}

function showPanel(id, btn) {
    document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
    document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
    document.getElementById('panel-'+id).classList.add('active');
    btn.classList.add('active');
}

function closeModal() { document.getElementById('overlay-main').classList.remove('open'); }

// ‚îÄ‚îÄ TRANSACCIONES ‚îÄ‚îÄ
function openTxSheet() {
    if(state.accounts.length === 0) return showToast("Crea una cuenta primero");
    
    let catsHtml = '<option value="">Sin categor√≠a (Va a Listo para Asignar)</option>';
    state.groups.forEach(g => {
        g.cats.forEach(c => catsHtml += `<option value="${c.id}">${g.name} - ${c.name}</option>`);
    });

    const modal = document.getElementById('modal-content');
    modal.innerHTML = `
        <h3 style="margin-bottom:15px">Movimiento</h3>
        <select id="t-ty" class="form-input" onchange="toggleCatSelect(this.value)">
            <option value="expense">Gasto</option>
            <option value="income">Ingreso</option>
        </select>
        <input id="t-am" type="number" class="form-input" placeholder="Importe (ej. 50.00)" step="0.01">
        <input id="t-co" class="form-input" placeholder="Concepto (opcional)">
        <input id="t-da" type="date" class="form-input">
        <label style="font-size:11px; color:var(--text-muted); margin-bottom:4px; display:block">Cuenta</label>
        <select id="t-ac" class="form-input">${state.accounts.map(a=>`<option value="${a.id}">${a.name}</option>`).join('')}</select>
        <label style="font-size:11px; color:var(--text-muted); margin-bottom:4px; display:block">Categor√≠a (Sobre)</label>
        <select id="t-ca" class="form-input">${catsHtml}</select>
        <button class="btn-save" onclick="addTx()">Guardar</button>
    `;
    document.getElementById('t-da').valueAsDate = new Date();
    // Forzar selecci√≥n correcta inicial
    toggleCatSelect('expense');
    document.getElementById('overlay-main').classList.add('open');
}

function toggleCatSelect(type) {
    const catSelect = document.getElementById('t-ca');
    if(type === 'expense') {
        // En gasto, forzar a la primera categor√≠a por defecto (no dejar vacio)
        if(catSelect.value === "") {
            for(let i=0; i<catSelect.options.length; i++) {
                if(catSelect.options[i].value !== "") { catSelect.selectedIndex = i; break; }
            }
        }
    } else {
        // En ingreso, sugerir ir al global (vac√≠o)
        catSelect.value = ""; 
    }
}

function addTx() {
    const amount = parseFloat(document.getElementById('t-am').value);
    if(!amount || amount <= 0) return showToast("Importe inv√°lido");
    
    const tx = {
        id: uid(),
        type: document.getElementById('t-ty').value,
        amount: amount,
        concept: document.getElementById('t-co').value || (document.getElementById('t-ty').value==='income'?'Ingreso':'Gasto'),
        date: document.getElementById('t-da').value,
        accountId: document.getElementById('t-ac').value,
        categoryId: document.getElementById('t-ca').value
    };
    
    state.transactions.push(tx);
    closeModal(); save(); showToast("Guardado");
}

function deleteTx(id) {
    state.transactions = state.transactions.filter(t => t.id !== id);
    save(); showToast("Movimiento borrado");
}

// ‚îÄ‚îÄ ASIGNACIONES (PRESUPUESTO) ‚îÄ‚îÄ
function openAssignDialog(id, name, currentVal) {
    const modal = document.getElementById('modal-content');
    modal.innerHTML = `
        <h3 style="margin-bottom:10px">Asignar a ${name}</h3>
        <p style="font-size:12px; color:var(--text-muted); margin-bottom:15px">Dinero a reservar en este mes. Puedes asignar en negativo para retirar dinero del sobre.</p>
        <input type="number" id="in-assign" class="form-input" value="${currentVal}" step="0.01">
        <button class="btn-save" onclick="setAssignment('${id}')">Aplicar Asignaci√≥n</button>
    `;
    document.getElementById('overlay-main').classList.add('open');
}

function setAssignment(catId) {
    const val = parseFloat(document.getElementById('in-assign').value) || 0;
    const mStr = getMStr(currentDate);
    if(!state.assignments[mStr]) state.assignments[mStr] = {};
    state.assignments[mStr][catId] = val;
    closeModal(); save();
}

// ‚îÄ‚îÄ GESTI√ìN CRUD ‚îÄ‚îÄ
function openAddAccount() {
    document.getElementById('modal-content').innerHTML = `<h3>Nueva Cuenta</h3><input id="na-em" class="form-input" placeholder="Emoji (ej. üí≥)"><input id="na-na" class="form-input" placeholder="Nombre"><input id="na-ba" type="number" class="form-input" placeholder="Saldo inicial (opcional)"><button class="btn-save" onclick="addAcc()">Crear</button>`;
    document.getElementById('overlay-main').classList.add('open');
}
function addAcc() {
    let id = uid(), b = parseFloat(document.getElementById('na-ba').value);
    state.accounts.push({id, name:document.getElementById('na-na').value||'Nueva Cuenta', emoji:document.getElementById('na-em').value||'üè¶'});
    if(b) state.transactions.push({id: uid(), type:'income', concept:'Saldo inicial', amount:b, date:new Date().toISOString().split('T')[0], accountId:id, categoryId:""});
    closeModal(); save();
}
function deleteAcc(id) {
    if(state.transactions.some(t=>t.accountId===id)) return showToast("Tiene movimientos, no se puede borrar");
    if(state.accounts.length <= 1) return showToast("Debes tener al menos 1 cuenta");
    state.accounts = state.accounts.filter(a=>a.id!==id); save();
}

function openAddGroup() {
    document.getElementById('modal-content').innerHTML = `<h3>Nuevo Grupo</h3><input id="ng-na" class="form-input" placeholder="Nombre (ej. Variables)"><button class="btn-save" onclick="addGroup()">Crear</button>`;
    document.getElementById('overlay-main').classList.add('open');
}
function addGroup() {
    state.groups.push({id:uid(), name:document.getElementById('ng-na').value||'Grupo', open:true, cats:[]});
    closeModal(); save();
}
function deleteGroup(id) {
    let g = state.groups.find(x=>x.id===id);
    if(g.cats.length > 0) return showToast("Borra las categor√≠as primero");
    state.groups = state.groups.filter(x=>x.id!==id); save();
}

function openAddCat(groupId) {
    document.getElementById('modal-content').innerHTML = `<h3>Nueva Categor√≠a</h3><input id="nc-em" class="form-input" placeholder="Emoji"><input id="nc-na" class="form-input" placeholder="Nombre"><button class="btn-save" onclick="addCat('${groupId}')">Crear</button>`;
    document.getElementById('overlay-main').classList.add('open');
}
function addCat(groupId) {
    let g = state.groups.find(x=>x.id===groupId);
    g.cats.push({id:uid(), name:document.getElementById('nc-na').value||'Categor√≠a', emoji:document.getElementById('nc-em').value||'üìå'});
    closeModal(); save();
}
function deleteCat(id) {
    if(state.transactions.some(t=>t.categoryId===id)) return showToast("Tiene movimientos asociados");
    state.groups.forEach(g => { g.cats = g.cats.filter(c => c.id !== id); });
    // Limpiar asignaciones
    Object.values(state.assignments).forEach(m => { delete m[id]; });
    save();
}

// INICIALIZAR
renderAll();
</script>
</body>
</html>


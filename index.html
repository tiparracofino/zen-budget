<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Èñì ‚Äî Ma Budget (Pro)</title>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;1,300&family=Zen+Kaku+Gothic+New:wght@300;400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --bg-dark: #181715; --bg-pill: #2C2B28; --text-gold: #C2A878;
    --text-green: #8DA980; --bg-banner: #4B6342; --text-banner-light: #C8D8BF;
    --bg-list-header: #EBE6DA; --bg-card: #FDFBF7; --text-main: #1C1C1A;
    --text-muted: #6B6B65; --border: rgba(28,28,26,0.06); --aka: #B04A4A;
  }
  * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color: transparent; }
  body { font-family: 'Zen Kaku Gothic New', sans-serif; background: var(--bg-list-header); color: var(--text-main); height: 100vh; overflow: hidden; }
  .app { display: flex; flex-direction: column; height: 100%; max-width: 480px; margin: 0 auto; background: var(--bg-list-header); position: relative; }
  
  /* HEADER */
  .top-header { background: var(--bg-dark); padding: 48px 20px 16px; flex-shrink: 0; }
  .top-bar { display: flex; align-items: center; justify-content: space-between; margin-bottom: 24px; }
  .logo { font-family: 'Cormorant Garamond', serif; font-size: 24px; color: var(--text-gold); letter-spacing: 0.12em; }
  .month-nav { display: flex; align-items: center; background: var(--bg-pill); border-radius: 20px; padding: 2px 4px; }
  .month-btn { background: none; border: none; color: white; width: 30px; height: 30px; cursor: pointer; }
  .month-label { font-size: 13px; color: white; min-width: 110px; text-align: center; text-transform: uppercase; }
  
  .summary-pills { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; }
  .pill { background: var(--bg-pill); border-radius: 12px; padding: 12px 8px; text-align: center; }
  .pill-label { font-size: 8px; text-transform: uppercase; color: rgba(255,255,255,0.4); margin-bottom: 4px; display: block; }
  .pill-value { font-family: 'Cormorant Garamond', serif; font-size: 15px; color: white; }

  .assign-banner { background: var(--bg-banner); padding: 16px 20px; display: flex; align-items: center; justify-content: space-between; transition: background 0.3s; }
  .assign-banner.warning { background: var(--aka); }
  .assign-value { font-family: 'Cormorant Garamond', serif; font-size: 22px; color: var(--text-banner-light); }

  /* CONTENT */
  .content { flex: 1; overflow-y: auto; padding-bottom: 100px; }
  .panel { display: none; } .panel.active { display: block; }
  .cat-row { background: var(--bg-card); padding: 16px 20px; display: flex; align-items: center; border-bottom: 1px solid var(--border); cursor: pointer; }
  .group-header { background: var(--bg-list-header); padding: 12px 20px; font-size: 10px; font-weight: 700; color: var(--text-muted); display: flex; justify-content: space-between; }
  
  /* NAV */
  .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: var(--bg-dark); display: flex; padding-bottom: env(safe-area-inset-bottom); }
  .nav-tab { flex: 1; display: flex; flex-direction: column; align-items: center; padding: 12px 0; color: rgba(255,255,255,0.4); background: none; border: none; }
  .nav-tab.active { color: var(--text-gold); }
  .nav-label { font-size: 8px; text-transform: uppercase; margin-top: 4px; }
  .fab { position: fixed; bottom: 85px; right: 20px; width: 56px; height: 56px; background: var(--bg-banner); border-radius: 50%; color: white; border: none; font-size: 24px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 10; }

  /* MODALS */
  .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: none; align-items: flex-end; z-index: 100; }
  .overlay.open { display: flex; }
  .sheet { background: var(--bg-card); width: 100%; padding: 24px; border-radius: 24px 24px 0 0; max-height: 80vh; overflow-y: auto; }
  .form-input { width: 100%; padding: 14px; margin-bottom: 12px; border: 1px solid var(--border); border-radius: 12px; font-size: 16px; }
  .btn-save { width: 100%; padding: 16px; background: var(--bg-banner); color: white; border: none; border-radius: 12px; font-weight: 600; }
  .neg-red { color: var(--aka) !important; }
</style>
</head>
<body>

<div class="app">
  <div class="top-header">
    <div class="top-bar">
      <div class="logo">Èñì MA</div>
      <div class="month-nav">
        <button class="month-btn" onclick="changeMonth(-1)">‚Äπ</button>
        <span class="month-label" id="monthLabel"></span>
        <button class="month-btn" onclick="changeMonth(1)">‚Ä∫</button>
      </div>
      <div style="width:24px"></div>
    </div>
    <div class="summary-pills">
      <div class="pill"><span class="pill-label">Asignado</span><span class="pill-value" id="s-assigned">0‚Ç¨</span></div>
      <div class="pill"><span class="pill-label">Actividad</span><span class="pill-value" id="s-spent">0‚Ç¨</span></div>
      <div class="pill"><span class="pill-label">Disponible</span><span class="pill-value" id="s-avail">0‚Ç¨</span></div>
    </div>
  </div>

  <div class="assign-banner" id="assignBanner">
    <div>
      <div style="font-size: 9px; text-transform: uppercase; color: var(--text-banner-light); opacity: 0.8">Listo para asignar (Simulaci√≥n Total)</div>
      <div style="font-size: 8px; color: var(--text-banner-light); opacity: 0.6">Considera ingresos/gastos futuros</div>
    </div>
    <div class="assign-value" id="toAssignVal">0,00‚Ç¨</div>
  </div>

  <div class="content">
    <div class="panel active" id="panel-budget"></div>
    <div class="panel" id="panel-mov"></div>
    <div class="panel" id="panel-manage">
        <div id="manage-accounts-list"></div>
        <div id="manage-structure-list"></div>
    </div>
  </div>

  <button class="fab" onclick="openTxSheet()">+</button>
  
  <nav class="bottom-nav">
    <button class="nav-tab active" onclick="showPanel('budget', this)">‚äû<span class="nav-label">Plan</span></button>
    <button class="nav-tab" onclick="showPanel('mov', this)">‚â°<span class="nav-label">Mov</span></button>
    <button class="nav-tab" onclick="showPanel('manage', this)">üè¶<span class="nav-label">Gesti√≥n</span></button>
  </nav>
</div>

<div class="overlay" id="overlay-main" onclick="closeModal()">
    <div class="sheet" onclick="event.stopPropagation()" id="modal-content"></div>
</div>

<script>
// --- MOTOR DE DATOS ---
const STORAGE_KEY = 'MA_DATA_V6';
let state = JSON.parse(localStorage.getItem(STORAGE_KEY)) || {
    transactions: [],
    assignments: {}, // Estructura: {"YYYY-MM": {catId: amount}}
    accounts: [{ id: 'a1', name: 'Principal', emoji: 'üè¶' }],
    groups: [{ id: 'g1', name: 'Obligatorio', cats: [{ id: 'c1', name: 'Alquiler', emoji: 'üè†' }] }]
};
let currentMonthDate = new Date();

const save = () => { localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); render(); };
const fmt = (n) => new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR' }).format(n);
const getMStr = (d) => `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;

// --- L√ìGICA DE SIMULACI√ìN FUTURA ---
// Calcula cu√°nto dinero hay realmente libre hoy, restando lo que ya has prometido en meses futuros
function getGlobalToAssign() {
    const totalIncome = state.transactions
        .filter(t => t.type === 'income')
        .reduce((sum, t) => sum + t.amount, 0);

    let totalAssignedEverywhere = 0;
    Object.values(state.assignments).forEach(monthMap => {
        Object.values(monthMap).forEach(val => totalAssignedEverywhere += val);
    });

    return totalIncome - totalAssignedEverywhere;
}

// Calcula el disponible de una categor√≠a teniendo en cuenta meses anteriores (Ahorro acumulado)
function getCategoryAvailable(catId, targetMonthStr) {
    let totalAssignedSoFar = 0;
    let totalActivitySoFar = 0;

    // Recorrer todos los meses hasta el seleccionado
    const months = Object.keys(state.assignments).sort();
    months.forEach(m => {
        if (m <= targetMonthStr) {
            totalAssignedSoFar += state.assignments[m][catId] || 0;
        }
    });

    state.transactions.forEach(t => {
        if (t.categoryId === catId && getMStr(new Date(t.date)) <= targetMonthStr) {
            // Si es gasto resta, si es ingreso suma (devoluci√≥n)
            totalActivitySoFar += (t.type === 'expense' ? -t.amount : t.amount);
        }
    });

    return totalAssignedSoFar + totalActivitySoFar;
}

// --- RENDERIZADO ---
function render() {
    const mStr = getMStr(currentMonthDate);
    document.getElementById('monthLabel').textContent = currentMonthDate.toLocaleString('es-ES', { month: 'long', year: 'numeric' });

    // 1. Panel Budget
    const budgetPanel = document.getElementById('panel-budget');
    budgetPanel.innerHTML = '';
    let mAssigned = 0, mActivity = 0;

    state.groups.forEach(g => {
        budgetPanel.innerHTML += `<div class="group-header"><span>${g.name}</span></div>`;
        g.cats.forEach(c => {
            const assigned = (state.assignments[mStr] && state.assignments[mStr][c.id]) || 0;
            const avail = getCategoryAvailable(c.id, mStr);
            const activity = state.transactions
                .filter(t => t.categoryId === c.id && getMStr(new Date(t.date)) === mStr)
                .reduce((acc, t) => t.type === 'expense' ? acc + t.amount : acc - t.amount, 0);

            mAssigned += assigned;
            mActivity += activity;

            budgetPanel.innerHTML += `
                <div class="cat-row" onclick="openAssignDialog('${c.id}','${c.name}',${assigned})">
                    <div style="flex:1"><span>${c.emoji}</span> <span style="font-size:14px">${c.name}</span></div>
                    <div style="text-align:right; min-width:80px">
                        <div style="font-size:10px; color:var(--text-muted)">${fmt(assigned)}</div>
                        <div style="font-size:14px; font-weight:500; color:${avail < 0 ? 'var(--aka)' : 'var(--bg-banner)'}">${fmt(avail)}</div>
                    </div>
                </div>`;
        });
    });

    // Totales superiores
    document.getElementById('s-assigned').textContent = fmt(mAssigned);
    document.getElementById('s-spent').textContent = fmt(mActivity);
    document.getElementById('s-avail').textContent = fmt(mAssigned - mActivity);

    // Banner de Simulaci√≥n Global
    const toAssign = getGlobalToAssign();
    const banner = document.getElementById('assignBanner');
    document.getElementById('toAssignVal').textContent = fmt(toAssign);
    banner.className = 'assign-banner ' + (toAssign < 0 ? 'warning' : '');
}

// --- GESTI√ìN DE TRANSACCIONES ---
function openTxSheet() {
    const modal = document.getElementById('modal-content');
    modal.innerHTML = `
        <h3 style="margin-bottom:20px">Nuevo Movimiento</h3>
        <select id="t-ty" class="form-input" onchange="toggleCatSelect(this.value)">
            <option value="expense">Gasto (-)</option>
            <option value="income">Ingreso (+)</option>
        </select>
        <input id="t-co" class="form-input" placeholder="Concepto (ej. Supermercado)">
        <input id="t-am" type="number" class="form-input" placeholder="Importe 0.00" step="0.01">
        <input id="t-da" type="date" class="form-input">
        <select id="t-ac" class="form-input">${state.accounts.map(a=>`<option value="${a.id}">${a.name}</option>`).join('')}</select>
        <select id="t-ca" class="form-input">
            <option value="">Sin categor√≠a (Ingreso General)</option>
            ${state.groups.flatMap(g=>g.cats).map(c=>`<option value="${c.id}">${c.name}</option>`).join('')}
        </select>
        <button class="btn-save" onclick="addTx()">Guardar Movimiento</button>
    `;
    document.getElementById('t-da').valueAsDate = new Date();
    document.getElementById('overlay-main').classList.add('open');
}

function addTx() {
    const amount = parseFloat(document.getElementById('t-am').value);
    if(!amount) return;

    const tx = {
        id: 't'+Date.now(),
        type: document.getElementById('t-ty').value,
        concept: document.getElementById('t-co').value,
        amount: amount,
        date: document.getElementById('t-da').value,
        accountId: document.getElementById('t-ac').value,
        categoryId: document.getElementById('t-ca').value
    };

    state.transactions.push(tx);
    closeModal();
    save();
}

function openAssignDialog(id, name, currentVal) {
    const modal = document.getElementById('modal-content');
    modal.innerHTML = `
        <h3 style="margin-bottom:10px">${name}</h3>
        <p style="font-size:12px; color:var(--text-muted); margin-bottom:20px">¬øCu√°nto quieres presupuestar para este mes?</p>
        <input type="number" id="in-assign" class="form-input" value="${currentVal}" step="0.01">
        <button class="btn-save" onclick="setAssignment('${id}')">Actualizar Plan</button>
    `;
    document.getElementById('overlay-main').classList.add('open');
}

function setAssignment(catId) {
    const val = parseFloat(document.getElementById('in-assign').value) || 0;
    const mStr = getMStr(currentMonthDate);
    if(!state.assignments[mStr]) state.assignments[mStr] = {};
    state.assignments[mStr][catId] = val;
    closeModal();
    save();
}

// --- UTILIDADES DE INTERFAZ ---
function toggleCatSelect(type) {
    const sel = document.getElementById('t-ca');
    // Si es ingreso, no es obligatorio poner categor√≠a (va a "Para asignar")
    sel.style.opacity = type === 'income' ? '0.5' : '1';
}

function changeMonth(diff) {
    currentMonthDate.setMonth(currentMonthDate.getMonth() + diff);
    render();
}

function showPanel(id, btn) {
    document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
    document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
    document.getElementById('panel-'+id).classList.add('active');
    btn.classList.add('active');
    render();
}

function closeModal() { document.getElementById('overlay-main').classList.remove('open'); }

// Iniciar
render();
</script>
</body>
</html>

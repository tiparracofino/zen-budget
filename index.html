<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Èñì ‚Äî Ma Budget</title>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,500;1,300;1,400&family=Zen+Kaku+Gothic+New:wght@300;400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --bg-dark: #181715;
    --bg-pill: #2C2B28;
    --text-gold: #C2A878;
    --text-green: #8DA980;
    --bg-banner: #4B6342;
    --text-banner-light: #C8D8BF;
    --bg-list-header: #EBE6DA;
    --bg-card: #FDFBF7;
    --text-main: #1C1C1A;
    --text-muted: #6B6B65;
    --border: rgba(28,28,26,0.06);
    --aka: #B04A4A;
    --edit-blue: #C2A878;
  }

  * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color: transparent; }
  body { font-family: 'Zen Kaku Gothic New', sans-serif; background: var(--bg-list-header); color: var(--text-main); overflow: hidden; height: 100vh; }

  .app { display: flex; flex-direction: column; height: 100%; max-width: 480px; margin: 0 auto; background: var(--bg-list-header); position: relative; }

  /* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
  .top-header { background: var(--bg-dark); padding: 48px 20px 16px; flex-shrink: 0; }
  .top-bar { display: flex; align-items: center; justify-content: space-between; margin-bottom: 24px; }
  .logo { font-family: 'Cormorant Garamond', serif; font-size: 24px; color: var(--text-gold); letter-spacing: 0.12em; }
  .month-nav { display: flex; align-items: center; background: var(--bg-pill); border-radius: 20px; padding: 2px 4px; }
  .month-btn { background: none; border: none; color: rgba(255,255,255,0.5); width: 30px; height: 30px; font-size: 16px; cursor: pointer; }
  .month-label { font-size: 13px; color: rgba(255,255,255,0.85); min-width: 100px; text-align: center; }
  
  .summary-pills { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; }
  .pill { background: var(--bg-pill); border-radius: 12px; padding: 12px 8px; text-align: center; }
  .pill-label { font-size: 8px; text-transform: uppercase; color: rgba(255,255,255,0.4); margin-bottom: 4px; display: block; }
  .pill-value { font-family: 'Cormorant Garamond', serif; font-size: 16px; color: rgba(255,255,255,0.85); }
  .pill-value.neg-red { color: var(--aka) !important; font-weight: 600; }

  .assign-banner { background: var(--bg-banner); padding: 16px 20px; display: flex; align-items: center; justify-content: space-between; }
  .assign-value { font-family: 'Cormorant Garamond', serif; font-size: 24px; color: var(--text-banner-light); }

  /* ‚îÄ‚îÄ CONTENT ‚îÄ‚îÄ */
  .content { flex: 1; overflow-y: auto; padding-bottom: 100px; }
  .panel { display: none; }
  .panel.active { display: block; }

  /* ‚îÄ‚îÄ SWIPE SYSTEM ‚îÄ‚îÄ */
  .swipe-container { position: relative; overflow: hidden; background: var(--bg-card); border-bottom: 1px solid var(--border); touch-action: pan-y; }
  
  .swipe-actions-left, .swipe-actions-right {
    position: absolute; top: 0; bottom: 0; display: flex; align-items: center; width: 80px; color: white; font-size: 14px; font-weight: 500; cursor: pointer;
  }
  .swipe-actions-left { left: 0; background: var(--edit-blue); justify-content: center; }
  .swipe-actions-right { right: 0; background: var(--aka); justify-content: center; }

  .swipe-content {
    position: relative; z-index: 2; background: var(--bg-card); padding: 16px 20px; display: grid; grid-template-columns: 1fr auto auto; align-items: center; transition: transform 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28);
  }

  /* ‚îÄ‚îÄ ROW STYLES ‚îÄ‚îÄ */
  .row-info { display: flex; align-items: center; gap: 12px; }
  .group-header { background: var(--bg-list-header); padding: 12px 20px; font-size: 10px; text-transform: uppercase; color: var(--text-muted); display: flex; justify-content: space-between; align-items: center; font-weight: 700; letter-spacing: 0.1em; }

  /* ‚îÄ‚îÄ NAV ‚îÄ‚îÄ */
  .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: var(--bg-dark); display: flex; padding-bottom: env(safe-area-inset-bottom); z-index: 50; }
  .nav-tab { flex: 1; display: flex; flex-direction: column; align-items: center; padding: 12px 0; color: rgba(255,255,255,0.4); background: none; border: none; }
  .nav-tab.active { color: var(--text-gold); }
  .nav-label { font-size: 8px; text-transform: uppercase; margin-top: 4px; }

  .fab { position: fixed; bottom: 85px; right: 20px; width: 56px; height: 56px; background: var(--bg-banner); border-radius: 50%; color: white; font-size: 24px; border: none; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 40; }

  /* ‚îÄ‚îÄ MODALS ‚îÄ‚îÄ */
  .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); display: none; align-items: flex-end; z-index: 100; }
  .overlay.open { display: flex; }
  .sheet { background: var(--bg-card); width: 100%; padding: 24px; border-radius: 20px 20px 0 0; max-height: 80vh; overflow-y: auto; }
  .form-input { width: 100%; padding: 14px; margin-bottom: 12px; border: 1px solid var(--border); border-radius: 10px; font-size: 15px; }
  .btn-save { width: 100%; padding: 16px; background: var(--bg-banner); color: white; border: none; border-radius: 12px; font-size: 16px; margin-top: 8px; }

  .toast { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%); background: var(--bg-dark); color: white; padding: 10px 20px; border-radius: 8px; opacity: 0; z-index: 200; pointer-events: none; transition: 0.3s; }
  .toast.show { opacity: 1; }
</style>
</head>
<body>

<div class="app">
  <div class="top-header">
    <div class="top-bar">
      <div class="logo">Èñì Ma</div>
      <div class="month-nav">
        <button class="month-btn" onclick="changeMonth(-1)">‚Äπ</button>
        <span class="month-label" id="monthLabel"></span>
        <button class="month-btn" onclick="changeMonth(1)">‚Ä∫</button>
      </div>
      <div style="width:24px"></div>
    </div>
    <div class="summary-pills">
      <div class="pill"><span class="pill-label">Asignado</span><span class="pill-value" id="s-assigned"></span></div>
      <div class="pill"><span class="pill-label">Gastado</span><span class="pill-value" id="s-spent"></span></div>
      <div class="pill"><span class="pill-label">Disponible</span><span class="pill-value" id="s-avail"></span></div>
    </div>
  </div>

  <div class="assign-banner">
    <div style="font-size: 9px; text-transform: uppercase; color: var(--text-banner-light); opacity: 0.7">Para asignar</div>
    <div class="assign-value" id="toAssignVal"></div>
  </div>

  <div class="content">
    <div class="panel active" id="panel-budget"></div>
    <div class="panel" id="panel-mov"></div>
    <div class="panel" id="panel-manage">
      <div class="group-header">CUENTAS <button onclick="openAccountSheet()" style="background:none; border:none; color:var(--text-gold)">+</button></div>
      <div id="manage-accounts-list"></div>
      <div class="group-header">ESTRUCTURA <button onclick="openGroupSheet()" style="background:none; border:none; color:var(--text-gold)">+ Grupo</button></div>
      <div id="manage-structure-list"></div>
    </div>
  </div>

  <button class="fab" onclick="openTxSheet()">+</button>
  <nav class="bottom-nav">
    <button class="nav-tab active" onclick="showPanel('budget', this)">‚äû<span class="nav-label">Plan</span></button>
    <button class="nav-tab" onclick="showPanel('mov', this)">‚â°<span class="nav-label">Mov</span></button>
    <button class="nav-tab" onclick="showPanel('manage', this)">üè¶<span class="nav-label">Gestionar</span></button>
  </nav>
</div>

<div id="toast" class="toast"></div>

<div class="overlay" id="overlay-generic" onclick="this.classList.remove('open')">
    <div class="sheet" onclick="event.stopPropagation()" id="generic-sheet-content"></div>
</div>

<script>
// --- DATA CORE ---
const STORAGE_KEY = 'MA_DATA_V3';
let state = JSON.parse(localStorage.getItem(STORAGE_KEY)) || {
    month: new Date().toISOString(),
    transactions: [],
    assignments: {},
    accounts: [{ id: 'a1', name: 'Efectivo', emoji: 'üíµ' }],
    groups: [{ id: 'g1', name: 'Esenciales', cats: [{ id: 'c1', name: 'Comida', emoji: 'üõí' }] }]
};
state.currentMonthDate = new Date(state.month);

function save() {
    state.month = state.currentMonthDate.toISOString();
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    render();
}

const fmt = (n) => (n < 0 ? '-' : '') + '‚Ç¨' + Math.abs(n).toFixed(2).replace('.', ',');
const getMStr = (d) => `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
const MONTHS = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];

function showToast(m) { const t = document.getElementById('toast'); t.textContent = m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 2000); }

// --- SWIPE LOGIC ---
let startX = 0, currentX = 0, activeSwipeEl = null;

function handleTouchStart(e) {
    startX = e.touches[0].clientX;
    activeSwipeEl = e.currentTarget.querySelector('.swipe-content');
    activeSwipeEl.style.transition = 'none';
}

function handleTouchMove(e) {
    if (!activeSwipeEl) return;
    currentX = e.touches[0].clientX - startX;
    // Limitar el swipe
    if (currentX > 80) currentX = 80;
    if (currentX < -80) currentX = -80;
    activeSwipeEl.style.transform = `translateX(${currentX}px)`;
}

function handleTouchEnd(e) {
    if (!activeSwipeEl) return;
    activeSwipeEl.style.transition = 'transform 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28)';
    if (currentX > 40) activeSwipeEl.style.transform = 'translateX(80px)';
    else if (currentX < -40) activeSwipeEl.style.transform = 'translateX(-80px)';
    else activeSwipeEl.style.transform = 'translateX(0)';
    currentX = 0;
}

// Cerrar swipes abiertos al hacer click fuera
document.addEventListener('touchstart', (e) => {
    if (!e.target.closest('.swipe-container')) {
        document.querySelectorAll('.swipe-content').forEach(el => el.style.transform = 'translateX(0)');
    }
});

// --- RENDER ENGINE ---
function render() {
    const mStr = getMStr(state.currentMonthDate);
    document.getElementById('monthLabel').textContent = MONTHS[state.currentMonthDate.getMonth()] + ' ' + state.currentMonthDate.getFullYear();

    // 1. Plan Panel
    const budgetPanel = document.getElementById('panel-budget');
    budgetPanel.innerHTML = '';
    let tSpent = 0, tAssigned = 0;

    state.groups.forEach(g => {
        budgetPanel.innerHTML += `<div class="group-header">${g.name}</div>`;
        g.cats.forEach(c => {
            let ass = (state.assignments[mStr] && state.assignments[mStr][c.id]) || 0;
            let spent = state.transactions.filter(t => t.categoryId === c.id && getMStr(new Date(t.date)) === mStr).reduce((a,b)=>a+b.amount,0);
            tAssigned += ass; tSpent += spent;
            let avail = ass - spent;
            budgetPanel.innerHTML += `
                <div class="swipe-container">
                    <div class="swipe-content" onclick="openAssignDialog('${c.id}', '${c.name}', ${ass})">
                        <div class="row-info"><span>${c.emoji}</span><span>${c.name}</span></div>
                        <div style="font-size:13px; color:var(--text-muted); text-align:right">${fmt(ass)}</div>
                        <div style="font-size:14px; text-align:right; width:80px" class="${avail < 0 ? 'neg' : 'pos'}">${fmt(avail)}</div>
                    </div>
                </div>`;
        });
    });

    // 2. Manage Panel (With Double Swipe)
    const structPanel = document.getElementById('manage-structure-list');
    structPanel.innerHTML = '';
    state.groups.forEach(g => {
        structPanel.innerHTML += `<div class="group-header"><span>${g.name}</span> <button onclick="openAddCatDialog('${g.id}')" style="background:none; border:none; color:var(--text-gold)">+ Cat</button></div>`;
        g.cats.forEach(c => {
            structPanel.innerHTML += `
                <div class="swipe-container" ontouchstart="handleTouchStart(event)" ontouchmove="handleTouchMove(event)" ontouchend="handleTouchEnd(event)">
                    <div class="swipe-actions-left" onclick="openEditCatDialog('${c.id}')">EDITAR</div>
                    <div class="swipe-actions-right" onclick="deleteCat('${c.id}')">BORRAR</div>
                    <div class="swipe-content">
                        <div class="row-info"><span>${c.emoji}</span><span>${c.name}</span></div>
                    </div>
                </div>`;
        });
    });

    // Cuentas
    const accPanel = document.getElementById('manage-accounts-list');
    accPanel.innerHTML = '';
    state.accounts.forEach(a => {
        let bal = state.transactions.filter(t=>t.accountId===a.id).reduce((sum,t)=>sum+(t.type==='income'?t.amount:-t.amount), 0);
        accPanel.innerHTML += `<div class="row-info" style="padding:16px 20px; background:#fff; border-bottom:1px solid var(--border)"><span>${a.emoji}</span><span>${a.name}</span> <span style="margin-left:auto">${fmt(bal)}</span></div>`;
    });

    // Summary
    document.getElementById('s-assigned').textContent = fmt(tAssigned);
    document.getElementById('s-spent').textContent = fmt(tSpent);
    const availFinal = tAssigned - tSpent;
    const availEl = document.getElementById('s-avail');
    availEl.textContent = fmt(availFinal);
    availEl.className = 'pill-value ' + (availFinal < 0 ? 'neg-red' : '');
    
    let totalIn = state.transactions.filter(t=>t.type==='income' && t.date <= mStr + '-31').reduce((a,b)=>a+b.amount, 0);
    let totalAssignedGlobal = 0;
    Object.keys(state.assignments).forEach(m => { if(m <= mStr) totalAssignedGlobal += Object.values(state.assignments[m]).reduce((a,b)=>a+b,0); });
    document.getElementById('toAssignVal').textContent = fmt(totalIn - totalAssignedGlobal);
}

// --- DIALOGS & ACTIONS ---
function openEditCatDialog(id) {
    let cat = null;
    state.groups.forEach(g => { let c = g.cats.find(x=>x.id===id); if(c) cat=c; });
    const sheet = document.getElementById('generic-sheet-content');
    sheet.innerHTML = `
        <h3>Editar Categor√≠a</h3>
        <input type="text" id="edit-emoji" class="form-input" value="${cat.emoji}">
        <input type="text" id="edit-name" class="form-input" value="${cat.name}">
        <button class="btn-save" onclick="saveEditCat('${id}')">Guardar Cambios</button>
    `;
    document.getElementById('overlay-generic').classList.add('open');
}

function saveEditCat(id) {
    state.groups.forEach(g => {
        let c = g.cats.find(x=>x.id===id);
        if(c) {
            c.name = document.getElementById('edit-name').value;
            c.emoji = document.getElementById('edit-emoji').value;
        }
    });
    document.getElementById('overlay-generic').classList.remove('open');
    save();
}

function deleteCat(id) {
    if (state.transactions.some(t => t.categoryId === id)) {
        showToast("No se puede: tiene movimientos");
        return;
    }
    state.groups.forEach(g => {
        const idx = g.cats.findIndex(c => c.id === id);
        if(idx !== -1) g.cats.splice(idx, 1);
    });
    save();
}

function openAssignDialog(id, name, val) {
    const sheet = document.getElementById('generic-sheet-content');
    sheet.innerHTML = `
        <h3>Asignar a ${name}</h3>
        <input type="number" id="new-ass" class="form-input" value="${val}" step="0.01">
        <button class="btn-save" onclick="finishAssign('${id}')">Confirmar</button>
    `;
    document.getElementById('overlay-generic').classList.add('open');
}

function finishAssign(id) {
    const mStr = getMStr(state.currentMonthDate);
    if(!state.assignments[mStr]) state.assignments[mStr] = {};
    state.assignments[mStr][id] = parseFloat(document.getElementById('new-ass').value) || 0;
    document.getElementById('overlay-generic').classList.remove('open');
    save();
}

// Funciones de utilidad para el resto de botones
function openAccountSheet() {
    const sheet = document.getElementById('generic-sheet-content');
    sheet.innerHTML = `
        <h3>Nueva Cuenta</h3>
        <input type="text" id="a-emoji" class="form-input" placeholder="Emoji">
        <input type="text" id="a-name" class="form-input" placeholder="Nombre">
        <input type="number" id="a-bal" class="form-input" placeholder="Saldo inicial">
        <button class="btn-save" onclick="state.accounts.push({id:'a'+Date.now(), name:document.getElementById('a-name').value, emoji:document.getElementById('a-emoji').value||'üè¶'}); let b=parseFloat(document.getElementById('a-bal').value); if(b) state.transactions.push({type:'income', concept:'Saldo inicial', amount:b, date:new Date().toISOString().split('T')[0], accountId:'a'+(Date.now()-1)}); document.getElementById('overlay-generic').classList.remove('open'); save();">Crear</button>
    `;
    document.getElementById('overlay-generic').classList.add('open');
}

function openAddCatDialog(gid) {
    const sheet = document.getElementById('generic-sheet-content');
    sheet.innerHTML = `
        <h3>Nueva Categor√≠a</h3>
        <input type="text" id="c-emoji" class="form-input" placeholder="Emoji">
        <input type="text" id="c-name" class="form-input" placeholder="Nombre">
        <button class="btn-save" onclick="state.groups.find(g=>g.id==='${gid}').cats.push({id:'c'+Date.now(), name:document.getElementById('c-name').value, emoji:document.getElementById('c-emoji').value||'üìå'}); document.getElementById('overlay-generic').classList.remove('open'); save();">A√±adir</button>
    `;
    document.getElementById('overlay-generic').classList.add('open');
}

function openGroupSheet() {
    const sheet = document.getElementById('generic-sheet-content');
    sheet.innerHTML = `
        <h3>Nuevo Grupo</h3>
        <input type="text" id="g-name" class="form-input" placeholder="Nombre">
        <button class="btn-save" onclick="state.groups.push({id:'g'+Date.now(), name:document.getElementById('g-name').value, cats:[]}); document.getElementById('overlay-generic').classList.remove('open'); save();">Crear</button>
    `;
    document.getElementById('overlay-generic').classList.add('open');
}

function openTxSheet() {
    const sheet = document.getElementById('generic-sheet-content');
    sheet.innerHTML = `
        <h3>Nuevo Movimiento</h3>
        <select id="t-type" class="form-input" onchange="document.getElementById('cat-sel').style.display = this.value==='expense'?'block':'none'"><option value="expense">Gasto</option><option value="income">Ingreso</option></select>
        <input type="text" id="t-con" class="form-input" placeholder="Concepto">
        <input type="number" id="t-amo" class="form-input" placeholder="0.00">
        <input type="date" id="t-dat" class="form-input">
        <select id="t-acc" class="form-input">${state.accounts.map(a=>`<option value="${a.id}">${a.name}</option>`).join('')}</select>
        <select id="cat-sel" class="form-input">${state.groups.flatMap(g=>g.cats).map(c=>`<option value="${c.id}">${c.name}</option>`).join('')}</select>
        <button class="btn-save" onclick="state.transactions.push({type:document.getElementById('t-type').value, concept:document.getElementById('t-con').value, amount:parseFloat(document.getElementById('t-amo').value), date:document.getElementById('t-dat').value, accountId:document.getElementById('t-acc').value, categoryId:document.getElementById('cat-sel').value}); document.getElementById('overlay-generic').classList.remove('open'); save();">Guardar</button>
    `;
    document.getElementById('t-dat').valueAsDate = new Date();
    document.getElementById('overlay-generic').classList.add('open');
}

function changeMonth(d) { state.currentMonthDate.setMonth(state.currentMonthDate.getMonth() + d); render(); }
function showPanel(id, btn) {
    document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
    document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
    document.getElementById('panel-'+id).classList.add('active');
    btn.classList.add('active');
}

render();
</script>
</body>
</html>

<style>
  /* Mejora de visibilidad para ingresos en movimientos */
  .text-income { color: var(--bg-banner) !important; font-weight: 600; }
  .text-expense { color: var(--aka) !important; }
  
  /* Selectores m√°s limpios */
  select.form-input { background: white; appearance: none; }
  
  /* Ajuste para el scroll */
  .content { padding-bottom: 120px; }
</style>

<script>
// --- MEJORA: GENERADOR DE IDS √öNICOS ---
const uid = () => 'id_' + Math.random().toString(36).substr(2, 9);

// --- DATA (RECARGA MEJORADA) ---
const STORAGE_KEY = 'MA_DATA_V5';
let state = JSON.parse(localStorage.getItem(STORAGE_KEY)) || {
    transactions: [],
    assignments: {},
    accounts: [{ id: 'a1', name: 'Cuenta Principal', emoji: 'üè¶' }],
    groups: [{ id: 'g1', name: 'Gastos Fijos', open: true, cats: [{ id: 'c1', name: 'Comida', emoji: 'üõí' }] }]
};
// Inicializar fecha de sesi√≥n (no se guarda en localStorage para que siempre abra en el mes actual)
state.currentMonthDate = new Date();

function save() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    render();
}

// --- UTILIDADES ---
const fmt = (n) => new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR' }).format(n);
const getMStr = (d) => `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;

// --- MEJORA: C√ÅLCULO DE DISPONIBLE ACUMULADO ---
function getAvailable(catId, monthStr) {
    let totalAssigned = 0;
    let totalSpent = 0;
    
    // Sumamos todo desde el inicio de los tiempos hasta el mes seleccionado
    // Esto permite que el ahorro "pase" al mes siguiente
    Object.keys(state.assignments).forEach(m => {
        if (m <= monthStr) {
            totalAssigned += state.assignments[m][catId] || 0;
        }
    });

    state.transactions.forEach(t => {
        if (t.categoryId === catId && getMStr(new Date(t.date)) <= monthStr) {
            totalSpent += t.amount;
        }
    });

    return totalAssigned - totalSpent;
}

// --- RENDER REVISADO ---
function render() {
    const mStr = getMStr(state.currentMonthDate);
    document.getElementById('monthLabel').textContent = 
        state.currentMonthDate.toLocaleString('es-ES', { month: 'long', year: 'numeric' }).toUpperCase();

    // 1. Panel de Planificaci√≥n (Budget)
    const budgetPanel = document.getElementById('panel-budget');
    if (budgetPanel.classList.contains('active')) {
        budgetPanel.innerHTML = '';
        let tSpentMonth = 0; 
        let tAssignedMonth = 0;

        state.groups.forEach(g => {
            const groupEl = document.createElement('div');
            groupEl.innerHTML = `<div class="group-header ${g.open?'':'closed'}" onclick="toggleGroup('${g.id}')">
                <span><span class="chevron">‚ñæ</span> ${g.name}</span>
            </div>`;
            
            const list = document.createElement('div');
            list.className = 'cat-list' + (g.open ? '' : ' hidden');
            
            g.cats.forEach(c => {
                const assigned = (state.assignments[mStr] && state.assignments[mStr][c.id]) || 0;
                const spentThisMonth = state.transactions
                    .filter(t => t.categoryId === c.id && getMStr(new Date(t.date)) === mStr)
                    .reduce((a, b) => a + b.amount, 0);
                
                const avail = getAvailable(c.id, mStr);
                
                tAssignedMonth += assigned;
                tSpentMonth += spentThisMonth;

                list.innerHTML += `
                    <div class="swipe-content" style="border-bottom:1px solid var(--border);" onclick="openAssignDialog('${c.id}','${c.name}',${assigned})">
                        <div class="row-info"><span>${c.emoji}</span><span>${c.name}</span></div>
                        <div class="val-box" style="color:var(--text-muted); font-size:12px">${fmt(assigned)}</div>
                        <div class="val-box ${avail < 0 ? 'neg-red' : ''}" style="font-size:14px; font-weight:500; color:${avail < 0 ? 'var(--aka)':'var(--bg-banner)'}">
                            ${fmt(avail)}
                        </div>
                    </div>`;
            });
            budgetPanel.appendChild(groupEl);
            budgetPanel.appendChild(list);
        });

        // Actualizar Sumarios
        document.getElementById('s-assigned').textContent = fmt(tAssignedMonth);
        document.getElementById('s-spent').textContent = fmt(tSpentMonth);
        
        // "Para asignar" = Ingresos totales - Asignaciones totales de toda la historia
        const totalIncome = state.transactions
            .filter(t => t.type === 'income')
            .reduce((a, b) => a + b.amount, 0);
        
        let totalAssignedAllTime = 0;
        Object.keys(state.assignments).forEach(m => {
            totalAssignedAllTime += Object.values(state.assignments[m]).reduce((a, b) => a + b, 0);
        });
        
        const toAssign = totalIncome - totalAssignedAllTime;
        const toAssignEl = document.getElementById('toAssignVal');
        toAssignEl.textContent = fmt(toAssign);
        toAssignEl.style.color = toAssign < 0 ? 'var(--aka)' : 'var(--text-banner-light)';
    }

    // El resto de renders (Movements y Manage) se llaman desde showPanel para optimizar
}

// --- OPCI√ìN NUEVA: A√ëADIR TRANSACCI√ìN MEJORADA ---
function addTx() {
    const type = document.getElementById('t-ty').value;
    const amount = parseFloat(document.getElementById('t-am').value);
    const concept = document.getElementById('t-co').value || 'Sin concepto';
    const date = document.getElementById('t-da').value;
    const accountId = document.getElementById('t-ac').value;
    const categoryId = type === 'expense' ? document.getElementById('t-ca').value : null;

    if (!amount || amount <= 0) return showToast("Introduce un importe v√°lido");

    state.transactions.push({ id: uid(), type, concept, amount, date, accountId, categoryId });
    document.getElementById('overlay-main').classList.remove('open');
    save();
    showToast("Movimiento guardado");
}

// ... (El resto de funciones de borrado y modales permanecen igual, pero usa la funci√≥n save() para refrescar)
</script>
